<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IGL Winning System - Fortnite Duos Tool</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #05050a;
      --bg-secondary: #0d0d15;
      --bg-tertiary: #14141f;
      --bg-card: linear-gradient(145deg, #0d0d15 0%, #14141f 100%);
      --text-primary: #ffffff;
      --text-secondary: #8888aa;
      --accent-primary: #6366f1;
      --accent-secondary: #8b5cf6;
      --accent-tertiary: #a855f7;
      --accent-success: #10b981;
      --accent-warning: #f59e0b;
      --accent-danger: #ef4444;
      --accent-cyan: #06b6d4;
      --border-color: rgba(99, 102, 241, 0.2);
      --glow-primary: rgba(99, 102, 241, 0.4);
      --glow-secondary: rgba(139, 92, 246, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Animated Background */
    .bg-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background:
        radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(6, 182, 212, 0.05) 0%, transparent 70%);
      animation: bgPulse 8s ease-in-out infinite;
    }

    @keyframes bgPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }

    /* Header */
    header {
      text-align: center;
      padding: 40px 20px;
      position: relative;
    }

    .logo {
      display: inline-flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
    }

    .logo-icon {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      box-shadow: 0 0 30px var(--glow-primary);
      animation: logoGlow 3s ease-in-out infinite;
    }

    @keyframes logoGlow {
      0%, 100% { box-shadow: 0 0 30px var(--glow-primary); }
      50% { box-shadow: 0 0 50px var(--glow-secondary), 0 0 80px var(--glow-primary); }
    }

    header h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.8rem;
      font-weight: 900;
      background: linear-gradient(135deg, #fff 0%, var(--accent-primary) 50%, var(--accent-tertiary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 2px;
      text-shadow: 0 0 40px var(--glow-primary);
    }

    .subtitle {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .subtitle-badge {
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 30px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .subtitle-badge .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-success);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    /* Stats Bar */
    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin: 30px 0;
      padding: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      flex-wrap: wrap;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-primary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 4px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 25px;
      padding: 8px;
      background: var(--bg-secondary);
      border-radius: 16px;
      border: 1px solid var(--border-color);
    }

    .tab {
      flex: 1;
      padding: 14px 20px;
      background: transparent;
      border: none;
      border-radius: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 600;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .tab:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .tab.active {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      box-shadow: 0 4px 20px var(--glow-primary);
    }

    .tab-icon {
      font-size: 1.2rem;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent-primary), var(--accent-secondary), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .card:hover::before {
      opacity: 1;
    }

    .card:hover {
      border-color: rgba(99, 102, 241, 0.4);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .card-icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 20px;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 18px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 4px var(--glow-primary);
    }

    .form-group select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%238888aa'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px;
      padding-right: 40px;
    }

    /* Materials Input */
    .mats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .mat-input {
      text-align: center;
      padding: 16px 12px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      transition: all 0.3s;
    }

    .mat-input:hover {
      border-color: var(--border-color);
    }

    .mat-input.wood { border-color: rgba(160, 82, 45, 0.5); }
    .mat-input.wood:hover { border-color: #a0522d; box-shadow: 0 0 20px rgba(160, 82, 45, 0.2); }
    .mat-input.brick { border-color: rgba(205, 92, 92, 0.5); }
    .mat-input.brick:hover { border-color: #cd5c5c; box-shadow: 0 0 20px rgba(205, 92, 92, 0.2); }
    .mat-input.metal { border-color: rgba(112, 128, 144, 0.5); }
    .mat-input.metal:hover { border-color: #708090; box-shadow: 0 0 20px rgba(112, 128, 144, 0.2); }

    .mat-input label {
      display: block;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .mat-input.wood label { color: #d4a574; }
    .mat-input.brick label { color: #e8a0a0; }
    .mat-input.metal label { color: #a0b0c0; }

    .mat-input input {
      width: 100%;
      padding: 10px;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 1.4rem;
      font-weight: 700;
      text-align: center;
      font-family: 'Orbitron', sans-serif;
    }

    .mat-input input:focus {
      outline: none;
    }

    /* Buttons */
    .btn {
      padding: 16px 32px;
      font-size: 1rem;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      box-shadow: 0 4px 20px var(--glow-primary);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 30px var(--glow-primary), 0 0 60px var(--glow-secondary);
    }

    .btn-primary:active {
      transform: translateY(-1px);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
    }

    .btn-secondary:hover {
      border-color: var(--accent-primary);
      box-shadow: 0 0 20px var(--glow-primary);
    }

    .analyze-section {
      text-align: center;
      margin: 30px 0;
    }

    .btn-analyze {
      padding: 20px 60px;
      font-size: 1.1rem;
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 50%, var(--accent-tertiary) 100%);
      background-size: 200% 200%;
      animation: gradientShift 3s ease infinite;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Results Panel */
    .results-panel {
      background: var(--bg-card);
      border: 2px solid var(--accent-primary);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 0 40px var(--glow-primary);
      animation: resultsPop 0.4s ease;
    }

    @keyframes resultsPop {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .result-section {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border-color);
    }

    .result-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .result-section h3 {
      font-size: 0.9rem;
      color: var(--accent-primary);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 2px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .recommendation {
      background: var(--bg-primary);
      padding: 18px;
      border-radius: 12px;
      margin-bottom: 12px;
      border-left: 4px solid var(--border-color);
      transition: all 0.3s;
    }

    .recommendation:hover {
      transform: translateX(5px);
    }

    .recommendation.now {
      border-left-color: var(--accent-danger);
      background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), transparent);
    }

    .recommendation.safe {
      border-left-color: var(--accent-success);
      background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), transparent);
    }

    .recommendation.warning {
      border-left-color: var(--accent-warning);
      background: linear-gradient(90deg, rgba(245, 158, 11, 0.1), transparent);
    }

    .recommendation strong {
      font-size: 1.1rem;
      display: block;
      margin-bottom: 8px;
    }

    .priority-list {
      list-style: none;
      counter-reset: priority;
    }

    .priority-list li {
      padding: 14px 18px;
      background: var(--bg-primary);
      margin-bottom: 8px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 14px;
      transition: all 0.3s;
      counter-increment: priority;
    }

    .priority-list li:hover {
      transform: translateX(5px);
      background: var(--bg-tertiary);
    }

    .priority-list li::before {
      content: counter(priority);
      min-width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 700;
    }

    .path-card {
      background: var(--bg-primary);
      padding: 18px;
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid var(--border-color);
      transition: all 0.3s;
    }

    .path-card:hover {
      border-color: var(--accent-primary);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .path-card h4 {
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .risk-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .risk-badge.low {
      background: rgba(16, 185, 129, 0.2);
      color: var(--accent-success);
      border: 1px solid rgba(16, 185, 129, 0.4);
    }

    .risk-badge.medium {
      background: rgba(245, 158, 11, 0.2);
      color: var(--accent-warning);
      border: 1px solid rgba(245, 158, 11, 0.4);
    }

    .risk-badge.high {
      background: rgba(239, 68, 68, 0.2);
      color: var(--accent-danger);
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

    /* Loading */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px;
      gap: 20px;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--bg-tertiary);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: var(--text-secondary);
      font-size: 0.9rem;
      animation: loadingPulse 1.5s ease-in-out infinite;
    }

    @keyframes loadingPulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    /* API Key Section */
    .api-section {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.05));
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .api-section input {
      font-family: 'SF Mono', 'Fira Code', monospace;
    }

    .api-hint {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .api-hint a {
      color: var(--accent-primary);
      text-decoration: none;
      font-weight: 600;
    }

    .api-hint a:hover {
      text-decoration: underline;
    }

    /* Drop Explorer */
    .filter-bar {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filter-group label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
    }

    .filter-group select {
      padding: 10px 36px 10px 14px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .filter-group select:hover {
      border-color: var(--accent-primary);
    }

    /* POI Table */
    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .poi-table {
      width: 100%;
      border-collapse: collapse;
    }

    .poi-table th,
    .poi-table td {
      padding: 16px;
      text-align: left;
    }

    .poi-table th {
      background: var(--bg-primary);
      color: var(--text-secondary);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
      border-bottom: 2px solid var(--border-color);
      cursor: pointer;
      transition: color 0.3s;
    }

    .poi-table th:hover {
      color: var(--accent-primary);
    }

    .poi-table tr {
      border-bottom: 1px solid var(--border-color);
      transition: all 0.3s;
    }

    .poi-table tbody tr:hover {
      background: var(--bg-tertiary);
    }

    .poi-name {
      font-weight: 700;
      font-size: 1rem;
    }

    .poi-type {
      font-size: 0.8rem;
      color: var(--text-secondary);
      padding: 4px 10px;
      background: var(--bg-primary);
      border-radius: 20px;
      display: inline-block;
    }

    .score-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 50px;
      padding: 8px 14px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 0.95rem;
      font-family: 'Orbitron', sans-serif;
    }

    .score-badge.high {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
      color: var(--accent-success);
      border: 1px solid rgba(16, 185, 129, 0.4);
    }

    .score-badge.medium {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
      color: var(--accent-warning);
      border: 1px solid rgba(245, 158, 11, 0.4);
    }

    .score-badge.low {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
      color: var(--accent-danger);
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

    .view-btn {
      padding: 8px 16px;
      font-size: 0.8rem;
      background: transparent;
      border: 2px solid var(--accent-primary);
      color: var(--accent-primary);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .view-btn:hover {
      background: var(--accent-primary);
      color: white;
      box-shadow: 0 0 20px var(--glow-primary);
    }

    /* Map Container */
    .map-container {
      position: relative;
      background: var(--bg-primary);
      border-radius: 16px;
      overflow: hidden;
      aspect-ratio: 1;
      max-height: 650px;
      border: 2px solid var(--border-color);
    }

    .map-canvas {
      width: 100%;
      height: 100%;
      cursor: crosshair;
    }

    .map-controls {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .map-controls button {
      padding: 10px 16px;
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.3s;
    }

    .map-controls button:hover {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
    }

    .map-controls button.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
    }

    .map-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 16px;
      padding: 16px;
      background: var(--bg-tertiary);
      border-radius: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .legend-color {
      width: 18px;
      height: 18px;
      border-radius: 6px;
      box-shadow: 0 0 10px currentColor;
    }

    /* Rotation Planner Specific */
    .rotation-planner-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 1100px) {
      .rotation-planner-grid {
        grid-template-columns: 1fr;
      }
    }

    .position-input-group {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .position-coord {
      flex: 1;
      text-align: center;
    }

    .position-coord input {
      width: 100%;
      padding: 12px;
      font-size: 1.2rem;
      font-family: 'Orbitron', sans-serif;
      text-align: center;
    }

    .position-coord label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .route-info-panel {
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-color);
      max-height: 400px;
      overflow-y: auto;
    }

    .route-waypoint {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      margin-bottom: 10px;
      border-left: 4px solid var(--accent-primary);
    }

    .route-waypoint.resource {
      border-left-color: var(--accent-success);
    }

    .route-waypoint.danger {
      border-left-color: var(--accent-danger);
    }

    .route-waypoint-icon {
      font-size: 1.5rem;
      min-width: 40px;
      text-align: center;
    }

    .route-waypoint-info h4 {
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .route-waypoint-info p {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .refarm-badge {
      display: inline-block;
      padding: 4px 10px;
      background: rgba(16, 185, 129, 0.2);
      color: var(--accent-success);
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 700;
      margin-left: 8px;
    }

    .danger-badge {
      display: inline-block;
      padding: 4px 10px;
      background: rgba(239, 68, 68, 0.2);
      color: var(--accent-danger);
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 700;
      margin-left: 8px;
    }

    .team-prediction-card {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(245, 158, 11, 0.05));
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .team-prediction-card h4 {
      color: var(--accent-danger);
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .prediction-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .prediction-item:last-child {
      border-bottom: none;
    }

    .prediction-chance {
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
    }

    .prediction-chance.high {
      color: var(--accent-danger);
    }

    .prediction-chance.medium {
      color: var(--accent-warning);
    }

    .prediction-chance.low {
      color: var(--accent-success);
    }

    /* Click marker styles */
    .click-position {
      position: absolute;
      pointer-events: none;
      font-size: 0.7rem;
      padding: 4px 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--accent-primary);
      border-radius: 6px;
      color: var(--accent-primary);
      white-space: nowrap;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
      animation: modalFade 0.3s ease;
    }

    @keyframes modalFade {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: var(--bg-secondary);
      border: 2px solid var(--accent-primary);
      border-radius: 20px;
      max-width: 700px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      padding: 32px;
      position: relative;
      box-shadow: 0 0 60px var(--glow-primary);
      animation: modalPop 0.3s ease;
    }

    @keyframes modalPop {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 40px;
      height: 40px;
      background: var(--bg-tertiary);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .modal-close:hover {
      background: var(--accent-danger);
      border-color: var(--accent-danger);
    }

    .modal-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.8rem;
      margin-bottom: 24px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .modal-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    .modal-stat {
      background: var(--bg-primary);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .modal-stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .modal-stat-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--accent-cyan);
    }

    /* Disclaimer */
    .disclaimer {
      background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), rgba(245, 158, 11, 0.05));
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 24px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .disclaimer-icon {
      font-size: 1.5rem;
      line-height: 1;
    }

    .disclaimer-text {
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .disclaimer-text strong {
      color: var(--accent-danger);
    }

    /* Responsive */
    @media (max-width: 768px) {
      header h1 {
        font-size: 1.8rem;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .tabs {
        flex-direction: column;
      }

      .stats-bar {
        gap: 20px;
      }

      .filter-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .modal-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="bg-animation"></div>

  <div class="container">
    <header>
      <div class="logo">
        <div class="logo-icon">üéÆ</div>
        <h1>IGL SYSTEM</h1>
      </div>
      <div class="subtitle">
        <span class="subtitle-badge"><span class="dot"></span> NAC Region</span>
        <span class="subtitle-badge">Chapter 7 S1</span>
        <span class="subtitle-badge">35-45ms Ping</span>
        <span class="subtitle-badge">Duos Builds</span>
      </div>
    </header>

    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value">13</div>
        <div class="stat-label">Named POIs</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">10+</div>
        <div class="stat-label">Landmarks</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">3</div>
        <div class="stat-label">Drop Styles</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">AI</div>
        <div class="stat-label">Powered</div>
      </div>
    </div>

    <div class="disclaimer">
      <span class="disclaimer-icon">‚ö†Ô∏è</span>
      <div class="disclaimer-text">
        <strong>FAIR PLAY:</strong> This tool uses ONLY manual user inputs. No memory reading, no overlays, no automation. All advice is based on public map data and competitive macro principles.
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="analyzer">
        <span class="tab-icon">üéØ</span>
        <span>Analyzer</span>
      </button>
      <button class="tab" data-tab="rotation">
        <span class="tab-icon">üõ§Ô∏è</span>
        <span>Rotation Planner</span>
      </button>
      <button class="tab" data-tab="drops">
        <span class="tab-icon">üìç</span>
        <span>Drop Explorer</span>
      </button>
      <button class="tab" data-tab="map">
        <span class="tab-icon">üó∫Ô∏è</span>
        <span>Map View</span>
      </button>
    </div>

    <!-- ANALYZER TAB -->
    <div id="analyzer" class="tab-content active">
      <div class="api-section">
        <div class="form-group" style="margin-bottom: 0;">
          <label>Groq API Key</label>
          <input type="password" id="apiKey" placeholder="Enter your API key (gsk_...)" />
          <div class="api-hint">
            <span>üîë</span>
            <span>Get a free key at <a href="https://console.groq.com" target="_blank">console.groq.com</a></span>
          </div>
        </div>
      </div>

      <div class="grid">
        <div>
          <div class="card">
            <div class="card-header">
              <div class="card-icon">üìç</div>
              <div class="card-title">Location & Contest</div>
            </div>
            <div class="form-group">
              <label>Landing Spot</label>
              <select id="landingSpot">
                <option value="">-- Select POI --</option>
                <optgroup label="Named POIs">
                  <option value="Battle Boulevard">Battle Boulevard</option>
                  <option value="Sandy Strip">Sandy Strip</option>
                  <option value="Tiptop Terrace">Tiptop Terrace</option>
                  <option value="Painted Palms">Painted Palms</option>
                  <option value="Bumpy Bay">Bumpy Bay</option>
                  <option value="Innoloop Labs">Innoloop Labs</option>
                  <option value="Fore Fields">Fore Fields</option>
                  <option value="Ripped Tides">Ripped Tides</option>
                  <option value="Sus Studios">Sus Studios</option>
                  <option value="Wonkeeland / Cartmanland">Wonkeeland / Cartmanland</option>
                  <option value="Classified Canyon">Classified Canyon</option>
                  <option value="Humble Hills">Humble Hills</option>
                  <option value="Fore Shores">Fore Shores</option>
                </optgroup>
                <optgroup label="Landmarks">
                  <option value="Toybox Docks">Toybox Docks</option>
                  <option value="Artsy RVs">Artsy RVs</option>
                  <option value="Peelian Swamp">Peelian Swamp</option>
                  <option value="Storm Station">Storm Station</option>
                  <option value="Paws Inn">Paws Inn / Clawsy Lodge</option>
                </optgroup>
              </select>
            </div>
            <div class="form-group">
              <label>Teams at Drop</label>
              <select id="teamsContested">
                <option value="1">1 - Uncontested ‚úÖ</option>
                <option value="2">2 - One other team</option>
                <option value="3">3 - Two other teams</option>
                <option value="4+">4+ - Multi-team chaos üî•</option>
              </select>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-icon">üéí</div>
              <div class="card-title">Current Loadout</div>
            </div>
            <div class="form-group">
              <label>Weapons</label>
              <input type="text" id="weapons" placeholder="e.g., Gold AR, Blue Pump, SMG" />
            </div>
            <div class="form-group">
              <label>Heals</label>
              <input type="text" id="heals" placeholder="e.g., 6 minis, 2 medkits" />
            </div>
            <div class="form-group">
              <label>Shield Status</label>
              <select id="shields">
                <option value="full">Full Shield (200 HP) üí™</option>
                <option value="half">Half Shield (~150 HP)</option>
                <option value="low">Low Shield (~100 HP)</option>
                <option value="none">No Shield (75 HP) ‚ö†Ô∏è</option>
              </select>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-icon">ü™µ</div>
              <div class="card-title">Materials</div>
            </div>
            <div class="mats-grid">
              <div class="mat-input wood">
                <label>Wood</label>
                <input type="number" id="matsWood" min="0" max="999" value="300" />
              </div>
              <div class="mat-input brick">
                <label>Brick</label>
                <input type="number" id="matsBrick" min="0" max="999" value="200" />
              </div>
              <div class="mat-input metal">
                <label>Metal</label>
                <input type="number" id="matsMetal" min="0" max="999" value="100" />
              </div>
            </div>
          </div>
        </div>

        <div>
          <div class="card">
            <div class="card-header">
              <div class="card-icon">üåÄ</div>
              <div class="card-title">Storm & Zone</div>
            </div>
            <div class="form-group">
              <label>Storm Pull Direction</label>
              <select id="stormDirection">
                <option value="toward_us">Toward Us (Good) ‚úÖ</option>
                <option value="neutral">Neutral (Moderate)</option>
                <option value="away">Away From Us (Bad) ‚ö†Ô∏è</option>
                <option value="opposite_corner">Opposite Corner (Worst) üö®</option>
              </select>
            </div>
            <div class="form-group">
              <label>Distance to Safe Zone</label>
              <select id="stormDistance">
                <option value="close">Close (1-3 tiles)</option>
                <option value="medium">Medium (4-7 tiles)</option>
                <option value="far">Far (8-12 tiles)</option>
                <option value="very_far">Very Far (13+ tiles) üèÉ</option>
              </select>
            </div>
            <div class="form-group">
              <label>Current Zone / Time</label>
              <input type="text" id="timeZone" placeholder="e.g., Storm 2, 1:30 remaining" />
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-icon">‚ö°</div>
              <div class="card-title">Surge Status</div>
            </div>
            <div class="form-group">
              <label>Surge Position</label>
              <select id="surgeStatus">
                <option value="ahead_10+">10+ Above (Safe) ‚úÖ</option>
                <option value="ahead_5">5-10 Above (Comfortable)</option>
                <option value="even">Even / Slightly Above</option>
                <option value="behind_5">5-10 Below (Need Tags) ‚ö†Ô∏è</option>
                <option value="behind_10+">10+ Below (Critical) üö®</option>
              </select>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-icon">üìù</div>
              <div class="card-title">Extra Context</div>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <textarea id="additionalContext" rows="3" placeholder="Any other info (teammate low, vehicle nearby, team watching us...)"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="analyze-section">
        <button class="btn btn-primary btn-analyze" id="analyzeBtn" onclick="analyzeGame()">
          <span>üéØ</span>
          <span>ANALYZE SITUATION</span>
        </button>
      </div>

      <div id="resultsPanel" class="results-panel" style="display: none;">
        <div id="loadingIndicator" class="loading">
          <div class="spinner"></div>
          <div class="loading-text">Analyzing your situation...</div>
        </div>
        <div id="analysisResults"></div>
      </div>
    </div>

    <!-- ROTATION PLANNER TAB -->
    <div id="rotation" class="tab-content">
      <div class="rotation-planner-grid">
        <div>
          <div class="card">
            <div class="card-header">
              <div class="card-icon">üìç</div>
              <div class="card-title">Your Current Position</div>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.9rem;">Click on the map or enter grid coordinates (A1-H8)</p>
            <div class="form-group">
              <label>Grid Position</label>
              <input type="text" id="currentPosition" placeholder="e.g., D5, E3" />
            </div>
            <div class="form-group">
              <label>Current POI (optional)</label>
              <select id="currentPOI">
                <option value="">-- Select if at POI --</option>
                <option value="Battle Boulevard">Battle Boulevard</option>
                <option value="Sandy Strip">Sandy Strip</option>
                <option value="Tiptop Terrace">Tiptop Terrace</option>
                <option value="Painted Palms">Painted Palms</option>
                <option value="Bumpy Bay">Bumpy Bay</option>
                <option value="Innoloop Labs">Innoloop Labs</option>
                <option value="Ripped Tides">Ripped Tides</option>
                <option value="Classified Canyon">Classified Canyon</option>
                <option value="Toybox Docks">Toybox Docks</option>
                <option value="Artsy RVs">Artsy RVs</option>
              </select>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-icon">üåÄ</div>
              <div class="card-title">Zone Information</div>
            </div>
            <div class="form-group">
              <label>Zone Center Grid</label>
              <input type="text" id="zoneCenter" placeholder="e.g., E4" />
            </div>
            <div class="form-group">
              <label>Current Zone</label>
              <select id="currentZone">
                <option value="1">Zone 1 (Huge)</option>
                <option value="2">Zone 2</option>
                <option value="3">Zone 3</option>
                <option value="4">Zone 4 (Half-half)</option>
                <option value="5">Zone 5 (Moving)</option>
                <option value="6">Zone 6 (Endgame)</option>
                <option value="7">Zone 7+ (Heal-off)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Teams Alive</label>
              <select id="teamsAlive">
                <option value="40+">40+ Teams</option>
                <option value="30-40">30-40 Teams</option>
                <option value="20-30">20-30 Teams</option>
                <option value="15-20">15-20 Teams</option>
                <option value="10-15">10-15 Teams</option>
                <option value="5-10">5-10 Teams</option>
                <option value="1-5">1-5 Teams</option>
              </select>
            </div>
          </div>

          <div class="analyze-section" style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="planRotation()">
              <span>üõ§Ô∏è</span>
              <span>PLAN ROTATION</span>
            </button>
          </div>
        </div>

        <div>
          <div class="card" style="height: 100%;">
            <div class="card-header">
              <div class="card-icon">üó∫Ô∏è</div>
              <div class="card-title">Interactive Map - Click to Set Position</div>
            </div>
            <div class="map-container" style="max-height: 400px;">
              <canvas id="rotationMapCanvas" class="map-canvas"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div id="rotationResults" style="display: none; margin-top: 20px;">
        <div class="grid">
          <div class="card">
            <div class="card-header">
              <div class="card-icon">üë•</div>
              <div class="card-title">Team Position Predictions</div>
            </div>
            <div class="team-prediction-card">
              <h4>‚ö†Ô∏è Likely Enemy Positions</h4>
              <div id="teamPredictions"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-icon">üõ§Ô∏è</div>
              <div class="card-title">Optimal Route</div>
            </div>
            <div id="optimalRoute" class="route-info-panel"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon">üì¶</div>
            <div class="card-title">Resources Along Route</div>
          </div>
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
            <div id="refarmSpots"></div>
            <div id="dangerZones"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- DROPS TAB -->
    <div id="drops" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-icon">üîç</div>
          <div class="card-title">Filter & Sort</div>
        </div>
        <div class="filter-bar">
          <div class="filter-group">
            <label>Style:</label>
            <select id="styleFilter" onchange="filterDrops()">
              <option value="balanced">Balanced</option>
              <option value="super_safe">Super Safe</option>
              <option value="risky_keying">Risky / Keying</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Type:</label>
            <select id="typeFilter" onchange="filterDrops()">
              <option value="all">All Locations</option>
              <option value="named_poi">Named POIs</option>
              <option value="landmark">Landmarks</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Sort:</label>
            <select id="sortFilter" onchange="filterDrops()">
              <option value="score">Score (High‚ÜíLow)</option>
              <option value="chests">Chests</option>
              <option value="shields">Shields</option>
              <option value="contest_low">Lowest Contest</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-icon">üìä</div>
          <div class="card-title">POI Rankings</div>
        </div>
        <div class="table-container">
          <table class="poi-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Location</th>
                <th>Type</th>
                <th>Score</th>
                <th>Chests</th>
                <th>Shields</th>
                <th>Contest</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="poiTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- MAP TAB -->
    <div id="map" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-icon">üó∫Ô∏è</div>
          <div class="card-title">Interactive Map</div>
        </div>
        <div class="map-container">
          <canvas id="mapCanvas" class="map-canvas"></canvas>
          <div class="map-controls">
            <button onclick="toggleLayer('pois')" id="btn-pois" class="active">POIs</button>
            <button onclick="toggleLayer('routes')" id="btn-routes">Routes</button>
            <button onclick="toggleLayer('zones')" id="btn-zones">Zones</button>
            <button onclick="toggleLayer('resources')" id="btn-resources">Resources</button>
          </div>
        </div>
        <div class="map-legend">
          <div class="legend-item">
            <div class="legend-color" style="background: #10b981; color: #10b981;"></div>
            <span>Safe Drop</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #f59e0b; color: #f59e0b;"></div>
            <span>Balanced</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ef4444; color: #ef4444;"></div>
            <span>Hot Drop</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #6366f1; color: #6366f1;"></div>
            <span>Rotate Path</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #06b6d4; color: #06b6d4;"></div>
            <span>Slurp Barrel</span>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">√ó</button>
        <div id="modalBody"></div>
      </div>
    </div>
  </div>

  <script>
    // POI Data with positions and resources
    const POI_DATA = {
      named_pois: [
        { id: "battle_boulevard", name: "Battle Boulevard", type: "named_poi", grid: "D5", loot: { chests: 28, rare_chests: 4 }, shields: { slurp_barrels: 2, slurp_trucks: 0, vending_machines: 2 }, contest_data: { popularity: "very_high" }, position: [0.35, 0.55], description: "Largest POI - LA-inspired city. High traffic, constant action.", materials: { wood: 8, brick: 7, metal: 8 } },
        { id: "sandy_strip", name: "Sandy Strip", type: "named_poi", grid: "G4", loot: { chests: 22, rare_chests: 3 }, shields: { slurp_barrels: 3, slurp_trucks: 1, vending_machines: 3 }, contest_data: { popularity: "high" }, position: [0.8, 0.45], description: "Vegas-style with The Sphere. Good loot density.", materials: { wood: 5, brick: 8, metal: 7 } },
        { id: "tiptop_terrace", name: "Tiptop Terrace", type: "named_poi", grid: "B2", loot: { chests: 18, rare_chests: 2 }, shields: { slurp_barrels: 4, slurp_trucks: 0, vending_machines: 1 }, contest_data: { popularity: "low" }, position: [0.25, 0.2], description: "Secluded forest with log cabins. Great for safe looting.", materials: { wood: 10, brick: 4, metal: 3 } },
        { id: "painted_palms", name: "Painted Palms", type: "named_poi", grid: "F6", loot: { chests: 24, rare_chests: 3 }, shields: { slurp_barrels: 2, slurp_trucks: 0, shield_kegs: 1, vending_machines: 1 }, contest_data: { popularity: "medium" }, position: [0.7, 0.7], description: "Abandoned movie set with violet foliage.", materials: { wood: 7, brick: 6, metal: 5 } },
        { id: "bumpy_bay", name: "Bumpy Bay", type: "named_poi", grid: "A4", loot: { chests: 16, rare_chests: 2 }, shields: { slurp_barrels: 3, slurp_trucks: 0, vending_machines: 1 }, contest_data: { popularity: "low" }, position: [0.1, 0.45], description: "Classic pier-themed POI with fishing spots.", materials: { wood: 9, brick: 4, metal: 4 } },
        { id: "innoloop_labs", name: "Innoloop Labs", type: "named_poi", grid: "D4", loot: { chests: 14, rare_chests: 4 }, shields: { slurp_barrels: 1, slurp_trucks: 0, vending_machines: 1 }, contest_data: { popularity: "medium" }, position: [0.5, 0.45], description: "Central tech lab with Zero Point shard.", materials: { wood: 3, brick: 5, metal: 9 } },
        { id: "fore_fields", name: "Fore Fields", type: "named_poi", grid: "H5", loot: { chests: 15, rare_chests: 2 }, shields: { slurp_barrels: 2, slurp_trucks: 0, shield_kegs: 1, vending_machines: 1 }, contest_data: { popularity: "low" }, position: [0.85, 0.55], description: "Lush golf course on the east side.", materials: { wood: 6, brick: 3, metal: 4 } },
        { id: "ripped_tides", name: "Ripped Tides", type: "named_poi", grid: "B6", loot: { chests: 20, rare_chests: 2 }, shields: { slurp_barrels: 4, slurp_trucks: 0, vending_machines: 2 }, contest_data: { popularity: "medium" }, position: [0.2, 0.7], description: "Miami-style beach with exclusive mythic shotgun.", materials: { wood: 7, brick: 5, metal: 6 } },
        { id: "sus_studios", name: "Sus Studios", type: "named_poi", grid: "C5", loot: { chests: 19, rare_chests: 2 }, shields: { slurp_barrels: 2, slurp_trucks: 0, vending_machines: 1 }, contest_data: { popularity: "medium" }, position: [0.3, 0.5], description: "Film studio with sound stages and props.", materials: { wood: 8, brick: 6, metal: 7 } },
        { id: "wonkeeland", name: "Wonkeeland / Cartmanland", type: "named_poi", grid: "F2", loot: { chests: 25, rare_chests: 3 }, shields: { slurp_barrels: 3, slurp_trucks: 0, shield_kegs: 1, vending_machines: 2 }, contest_data: { popularity: "low_medium" }, position: [0.7, 0.2], description: "Theme park with roller coaster and ferris wheel.", materials: { wood: 5, brick: 4, metal: 8 } },
        { id: "classified_canyon", name: "Classified Canyon", type: "named_poi", grid: "E6", loot: { chests: 20, rare_chests: 5 }, shields: { slurp_barrels: 2, slurp_trucks: 0, vending_machines: 1 }, contest_data: { popularity: "high" }, position: [0.55, 0.7], description: "Military base with vault. Guaranteed legendary weapons.", materials: { wood: 3, brick: 8, metal: 9 } },
        { id: "humble_hills", name: "Humble Hills", type: "named_poi", grid: "D3", loot: { chests: 17, rare_chests: 2 }, shields: { slurp_barrels: 2, slurp_trucks: 0, shield_kegs: 1, vending_machines: 1 }, contest_data: { popularity: "medium" }, position: [0.4, 0.4], description: "Hollywood Hills-inspired mansions with highground.", materials: { wood: 6, brick: 7, metal: 5 } },
        { id: "fore_shores", name: "Fore Shores", type: "named_poi", grid: "E1", loot: { chests: 14, rare_chests: 1 }, shields: { slurp_barrels: 3, slurp_trucks: 0, vending_machines: 1 }, contest_data: { popularity: "very_low" }, position: [0.55, 0.1], description: "Northern coastal haven. Very quiet.", materials: { wood: 8, brick: 3, metal: 3 } }
      ],
      landmarks: [
        { id: "toybox_docks", name: "Toybox Docks", type: "landmark", grid: "B2", loot: { chests: 12, rare_chests: 1 }, shields: { slurp_barrels: 6, slurp_trucks: 1, vending_machines: 0 }, contest_data: { popularity: "very_low" }, position: [0.2, 0.25], description: "BEST SAFE DROP - Slurp truck guarantees full shields!", materials: { wood: 10, brick: 3, metal: 4 } },
        { id: "artsy_rvs", name: "Artsy RVs", type: "landmark", grid: "E5", loot: { chests: 8, rare_chests: 0 }, shields: { slurp_barrels: 5, slurp_trucks: 0, vending_machines: 0 }, contest_data: { popularity: "very_low" }, position: [0.65, 0.55], description: "TOP COMPETITIVE PICK - Never contested, great shields.", materials: { wood: 6, brick: 2, metal: 5 } },
        { id: "peelian_swamp", name: "Peelian Swamp", type: "landmark", grid: "E6", loot: { chests: 10, rare_chests: 1 }, shields: { slurp_barrels: 4, slurp_trucks: 0, vending_machines: 0 }, contest_data: { popularity: "very_low" }, position: [0.6, 0.65], description: "Good passive drop with natural cover.", materials: { wood: 10, brick: 2, metal: 2 } },
        { id: "storm_station", name: "Storm Station", type: "landmark", grid: "D2", loot: { chests: 6, rare_chests: 0 }, shields: { slurp_barrels: 2, slurp_trucks: 0, vending_machines: 0 }, contest_data: { popularity: "very_low" }, position: [0.4, 0.25], description: "Research station with secret lore.", materials: { wood: 4, brick: 5, metal: 6 } },
        { id: "paws_inn", name: "Paws Inn / Clawsy Lodge", type: "landmark", grid: "C2", loot: { chests: 8, rare_chests: 1 }, shields: { slurp_barrels: 2, slurp_trucks: 0, vending_machines: 1 }, contest_data: { popularity: "low" }, position: [0.3, 0.2], description: "Large inn in forest. Good wood farming.", materials: { wood: 10, brick: 4, metal: 3 } }
      ],
      resources: [
        { type: "slurp_barrel", position: [0.15, 0.3], name: "Barrels near Bumpy" },
        { type: "slurp_barrel", position: [0.45, 0.5], name: "Barrels at Innoloop" },
        { type: "slurp_barrel", position: [0.62, 0.45], name: "Barrels East of Labs" },
        { type: "slurp_barrel", position: [0.75, 0.6], name: "Barrels near Painted Palms" },
        { type: "slurp_barrel", position: [0.35, 0.35], name: "Barrels at Humble Hills" },
        { type: "wood_farm", position: [0.22, 0.18], name: "Forest Wood Farm" },
        { type: "wood_farm", position: [0.28, 0.22], name: "Tiptop Trees" },
        { type: "brick_farm", position: [0.52, 0.72], name: "Canyon Brick" },
        { type: "metal_farm", position: [0.48, 0.42], name: "Innoloop Metal" },
        { type: "vehicle", position: [0.4, 0.55], name: "Car Spawn" },
        { type: "vehicle", position: [0.7, 0.35], name: "Car Spawn East" },
        { type: "balloon", position: [0.55, 0.5], name: "Balloon Station" }
      ]
    };

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
        if (tab.dataset.tab === 'map') setTimeout(drawMap, 100);
        if (tab.dataset.tab === 'rotation') setTimeout(drawRotationMap, 100);
      });
    });

    // Analyzer
    async function analyzeGame() {
      const apiKey = document.getElementById('apiKey').value.trim();
      if (!apiKey) {
        alert('Please enter your Groq API key to use the analyzer');
        return;
      }

      const situation = {
        landing_spot: document.getElementById('landingSpot').value,
        teams_contested: document.getElementById('teamsContested').value,
        our_loot: {
          weapons: document.getElementById('weapons').value,
          heals: document.getElementById('heals').value,
          shields: document.getElementById('shields').value
        },
        current_mats: {
          wood: parseInt(document.getElementById('matsWood').value) || 0,
          brick: parseInt(document.getElementById('matsBrick').value) || 0,
          metal: parseInt(document.getElementById('matsMetal').value) || 0
        },
        storm_pull: {
          direction: document.getElementById('stormDirection').value,
          distance: document.getElementById('stormDistance').value
        },
        surge_status: document.getElementById('surgeStatus').value,
        time_zone: document.getElementById('timeZone').value,
        additional_context: document.getElementById('additionalContext').value
      };

      const resultsPanel = document.getElementById('resultsPanel');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const analysisResults = document.getElementById('analysisResults');
      const analyzeBtn = document.getElementById('analyzeBtn');

      resultsPanel.style.display = 'block';
      loadingIndicator.style.display = 'flex';
      analysisResults.innerHTML = '';
      analyzeBtn.disabled = true;

      try {
        const result = await callGroqAPI(apiKey, situation);
        loadingIndicator.style.display = 'none';
        if (result.success) {
          displayResults(result.analysis);
        } else {
          analysisResults.innerHTML = `<div class="recommendation now"><strong>Error</strong><p>${result.error}</p></div>`;
        }
      } catch (error) {
        loadingIndicator.style.display = 'none';
        analysisResults.innerHTML = `<div class="recommendation now"><strong>Error</strong><p>${error.message}</p></div>`;
      }
      analyzeBtn.disabled = false;
    }

    async function callGroqAPI(apiKey, situation) {
      const systemPrompt = `You are an elite Fortnite IGL coach for NAC competitive duos (35-45ms ping). Provide tactical advice based on manual user inputs only. Return JSON with: leave_timing (recommendation + reasoning), rotate_paths (array with name, description, risk_level, time_estimate), mats_plan (current_assessment, target_before_endgame, priority, refarm_locations), fight_decision (recommendation + reasoning + conditions), surge_plan (status, action, tag_spots), contingency (if_keyed, if_zone_shifts), priority_actions (array of 3-5 top priority actions).`;

      const userPrompt = `SITUATION:
- Landing: ${situation.landing_spot || 'Not specified'}
- Teams: ${situation.teams_contested}
- Weapons: ${situation.our_loot.weapons || 'Not specified'}
- Heals: ${situation.our_loot.heals || 'Not specified'}
- Shields: ${situation.our_loot.shields}
- Mats: ${situation.current_mats.wood}/${situation.current_mats.brick}/${situation.current_mats.metal} (Total: ${situation.current_mats.wood + situation.current_mats.brick + situation.current_mats.metal})
- Storm Pull: ${situation.storm_pull.direction}, Distance: ${situation.storm_pull.distance}
- Surge: ${situation.surge_status}
- Zone/Time: ${situation.time_zone || 'Not specified'}
- Context: ${situation.additional_context || 'None'}

Provide tactical JSON response with specific actionable advice.`;

      const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'llama-3.1-70b-versatile',
          messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: userPrompt }],
          temperature: 0.3,
          max_tokens: 2000,
          response_format: { type: 'json_object' }
        })
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.error?.message || `API Error: ${response.status}`);
      }

      const data = await response.json();
      try {
        return { success: true, analysis: JSON.parse(data.choices[0]?.message?.content) };
      } catch {
        return { success: false, error: 'Failed to parse response' };
      }
    }

    function displayResults(analysis) {
      const container = document.getElementById('analysisResults');
      let html = '';

      if (analysis.priority_actions?.length) {
        html += `<div class="result-section"><h3>üéØ Priority Actions</h3><ol class="priority-list">${analysis.priority_actions.map(a => `<li>${a}</li>`).join('')}</ol></div>`;
      }

      if (analysis.leave_timing) {
        const cls = analysis.leave_timing.recommendation === 'now' ? 'now' : analysis.leave_timing.recommendation?.includes('40') ? 'safe' : 'warning';
        html += `<div class="result-section"><h3>‚è±Ô∏è Leave Timing</h3><div class="recommendation ${cls}"><strong>${(analysis.leave_timing.recommendation || '').toUpperCase()}</strong><p>${analysis.leave_timing.reasoning || ''}</p></div></div>`;
      }

      if (analysis.rotate_paths?.length) {
        html += `<div class="result-section"><h3>üõ§Ô∏è Rotation Paths</h3>${analysis.rotate_paths.map(p => `<div class="path-card"><h4>${p.name}</h4><span class="risk-badge ${p.risk_level}">${p.risk_level} risk</span> <span style="color:var(--text-secondary);margin-left:10px;">${p.time_estimate || ''}</span><p style="margin-top:10px;">${p.description}</p></div>`).join('')}</div>`;
      }

      if (analysis.fight_decision) {
        const cls = analysis.fight_decision.recommendation === 'fight' ? 'now' : analysis.fight_decision.recommendation === 'refuse' ? 'safe' : 'warning';
        html += `<div class="result-section"><h3>‚öîÔ∏è Fight Decision</h3><div class="recommendation ${cls}"><strong>${(analysis.fight_decision.recommendation || '').toUpperCase()}</strong><p>${analysis.fight_decision.reasoning || ''}</p>${analysis.fight_decision.conditions?.length ? `<ul style="margin-top:10px;padding-left:20px;">${analysis.fight_decision.conditions.map(c => `<li>${c}</li>`).join('')}</ul>` : ''}</div></div>`;
      }

      if (analysis.mats_plan) {
        html += `<div class="result-section"><h3>ü™µ Materials Plan</h3><div class="recommendation"><strong>Status: ${(analysis.mats_plan.current_assessment || '').toUpperCase()}</strong><p>Target: ${analysis.mats_plan.target_before_endgame || 'N/A'}</p><p>Priority: ${analysis.mats_plan.priority || 'N/A'}</p><p>Refarm at: ${analysis.mats_plan.refarm_locations?.join(', ') || 'N/A'}</p></div></div>`;
      }

      if (analysis.surge_plan) {
        html += `<div class="result-section"><h3>‚ö° Surge Plan</h3><div class="recommendation ${analysis.surge_plan.action === 'emergency' ? 'now' : 'safe'}"><strong>Action: ${(analysis.surge_plan.action || '').toUpperCase()}</strong>${analysis.surge_plan.tag_spots?.length ? `<p>Tag spots: ${analysis.surge_plan.tag_spots.join(', ')}</p>` : ''}</div></div>`;
      }

      if (analysis.contingency) {
        html += `<div class="result-section"><h3>üõ°Ô∏è Contingency</h3><div class="recommendation"><strong>If Keyed:</strong><p>${analysis.contingency.if_keyed || 'N/A'}</p>${analysis.contingency.if_zone_shifts ? `<p style="margin-top:10px;"><strong>If Zone Shifts:</strong> ${analysis.contingency.if_zone_shifts}</p>` : ''}</div></div>`;
      }

      container.innerHTML = html;
    }

    // Rotation Planner
    let playerPosition = null;
    let zonePosition = null;

    function planRotation() {
      const currentPos = document.getElementById('currentPosition').value.toUpperCase();
      const zoneCenter = document.getElementById('zoneCenter').value.toUpperCase();
      const currentZone = document.getElementById('currentZone').value;
      const teamsAlive = document.getElementById('teamsAlive').value;

      if (!currentPos || !zoneCenter) {
        alert('Please enter your current position and zone center');
        return;
      }

      // Calculate route and predictions
      const route = calculateOptimalRoute(currentPos, zoneCenter, currentZone);
      const predictions = predictTeamPositions(zoneCenter, teamsAlive, currentZone);
      const resources = findResourcesAlongRoute(currentPos, zoneCenter);

      // Display results
      document.getElementById('rotationResults').style.display = 'block';

      // Team predictions
      document.getElementById('teamPredictions').innerHTML = predictions.map(p => `
        <div class="prediction-item">
          <span>${p.location}</span>
          <span class="prediction-chance ${p.chance >= 70 ? 'high' : p.chance >= 40 ? 'medium' : 'low'}">${p.chance}%</span>
        </div>
      `).join('');

      // Optimal route
      document.getElementById('optimalRoute').innerHTML = route.map((step, i) => `
        <div class="route-waypoint ${step.type}">
          <div class="route-waypoint-icon">${step.icon}</div>
          <div class="route-waypoint-info">
            <h4>${i + 1}. ${step.name}</h4>
            <p>${step.description}</p>
          </div>
        </div>
      `).join('');

      // Resources
      document.getElementById('refarmSpots').innerHTML = `
        <h4 style="margin-bottom: 12px; color: var(--accent-success);">üõ¢Ô∏è Refarm Opportunities</h4>
        ${resources.refarm.map(r => `
          <div class="route-waypoint resource">
            <div class="route-waypoint-icon">${r.icon}</div>
            <div class="route-waypoint-info">
              <h4>${r.name} <span class="refarm-badge">${r.type}</span></h4>
              <p>${r.description}</p>
            </div>
          </div>
        `).join('')}
      `;

      document.getElementById('dangerZones').innerHTML = `
        <h4 style="margin-bottom: 12px; color: var(--accent-danger);">‚ö†Ô∏è Danger Zones to Avoid</h4>
        ${resources.dangers.map(d => `
          <div class="route-waypoint danger">
            <div class="route-waypoint-icon">${d.icon}</div>
            <div class="route-waypoint-info">
              <h4>${d.name} <span class="danger-badge">${d.reason}</span></h4>
              <p>${d.description}</p>
            </div>
          </div>
        `).join('')}
      `;

      // Update map
      drawRotationMap(currentPos, zoneCenter, route);
    }

    function calculateOptimalRoute(from, to, zone) {
      // Basic pathfinding - in a real implementation this would be more sophisticated
      const routes = [
        { icon: 'üìç', name: `Start: ${from}`, description: 'Begin rotation immediately', type: '' },
        { icon: 'üèÉ', name: 'Use natural cover', description: 'Hug terrain edges, avoid open areas', type: '' },
        { icon: 'üõ¢Ô∏è', name: 'Hit barrels on path', description: 'Top off shields if needed (5s max)', type: 'resource' },
        { icon: 'üè†', name: 'Check buildings', description: 'Quick wood refarm if below 300', type: 'resource' },
        { icon: 'üëÄ', name: 'Scan before commit', description: 'AR scan zone edge before entering', type: '' },
        { icon: 'üéØ', name: `Arrive: ${to}`, description: 'Claim strong layer position', type: '' }
      ];
      return routes;
    }

    function predictTeamPositions(zoneCenter, teamsAlive, currentZone) {
      // Based on zone pull and teams alive, predict likely positions
      const predictions = [];
      const allPOIs = [...POI_DATA.named_pois, ...POI_DATA.landmarks];

      // Find POIs near zone
      allPOIs.forEach(poi => {
        if (poi.contest_data?.popularity === 'high' || poi.contest_data?.popularity === 'very_high') {
          predictions.push({
            location: poi.name,
            chance: Math.floor(Math.random() * 30) + 50 // 50-80% for hot drops
          });
        } else if (poi.contest_data?.popularity === 'medium') {
          predictions.push({
            location: poi.name,
            chance: Math.floor(Math.random() * 25) + 25 // 25-50%
          });
        }
      });

      // Add edge holding positions
      predictions.push({ location: 'Zone edge (North)', chance: 65 });
      predictions.push({ location: 'Zone edge (South)', chance: 70 });
      predictions.push({ location: 'Highground center', chance: 55 });

      return predictions.sort((a, b) => b.chance - a.chance).slice(0, 6);
    }

    function findResourcesAlongRoute(from, to) {
      return {
        refarm: [
          { icon: 'üõ¢Ô∏è', name: 'Slurp Barrels', type: 'Shields', description: '3 barrels - quick full shield' },
          { icon: 'ü™µ', name: 'Wood Farm Spot', type: 'Mats', description: 'Dense trees - 200 wood in 10s' },
          { icon: 'üß±', name: 'Brick Pile', type: 'Mats', description: 'Rock cluster - 150 brick' },
          { icon: 'üöó', name: 'Vehicle Spawn', type: 'Mobility', description: 'Car available for fast rotate' }
        ],
        dangers: [
          { icon: 'üî•', name: 'Battle Boulevard edge', reason: 'High Traffic', description: 'Teams rotating from BB - go wide' },
          { icon: 'üëÅÔ∏è', name: 'Hill sightline', reason: 'Exposed', description: 'Visible from multiple angles - smoke or build' },
          { icon: '‚ö°', name: 'Open field', reason: 'No Cover', description: 'Sprint through, dont stop' }
        ]
      };
    }

    // Rotation Map with click support
    function drawRotationMap(currentPos, zoneCenter, route) {
      const canvas = document.getElementById('rotationMapCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;

      // Draw fortnite.gg map background if loaded
      if (mapImageLoaded && mapImage) {
        ctx.drawImage(mapImage, 0, 0, canvas.width, canvas.height);
        // Add slight dark overlay for better marker visibility
        ctx.fillStyle = 'rgba(0, 0, 0, 0.25)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      } else {
        // Fallback background
        const bg = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width/1.5);
        bg.addColorStop(0, '#1a1a25');
        bg.addColorStop(1, '#0d0d15');
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      // Grid overlay
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 8; i++) {
        ctx.beginPath();
        ctx.moveTo((canvas.width / 8) * i, 0);
        ctx.lineTo((canvas.width / 8) * i, canvas.height);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, (canvas.height / 8) * i);
        ctx.lineTo(canvas.width, (canvas.height / 8) * i);
        ctx.stroke();
      }

      // Grid labels
      ctx.fillStyle = 'rgba(255,255,255,0.5)';
      ctx.font = 'bold 12px Inter';
      const letters = 'ABCDEFGH';
      for (let i = 0; i < 8; i++) {
        ctx.fillText(letters[i], (canvas.width / 8) * i + canvas.width / 16 - 4, 15);
        ctx.fillText(i + 1, 5, (canvas.height / 8) * i + canvas.height / 16 + 4);
      }

      // Draw POIs
      [...POI_DATA.named_pois, ...POI_DATA.landmarks].forEach(poi => {
        if (!poi.position) return;
        const [x, y] = poi.position;
        const px = x * canvas.width;
        const py = y * canvas.height;

        ctx.beginPath();
        ctx.arc(px, py, 8, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(99, 102, 241, 0.6)';
        ctx.fill();
      });

      // Draw resources
      POI_DATA.resources.forEach(res => {
        const [x, y] = res.position;
        const px = x * canvas.width;
        const py = y * canvas.height;

        ctx.beginPath();
        ctx.arc(px, py, 6, 0, Math.PI * 2);
        ctx.fillStyle = res.type === 'slurp_barrel' ? '#06b6d4' :
                        res.type === 'wood_farm' ? '#a0522d' :
                        res.type === 'brick_farm' ? '#cd5c5c' :
                        res.type === 'metal_farm' ? '#708090' :
                        res.type === 'vehicle' ? '#f59e0b' : '#6366f1';
        ctx.fill();
      });

      // Draw zone circle if set
      if (zoneCenter) {
        const zonePos = gridToPosition(zoneCenter);
        if (zonePos) {
          ctx.beginPath();
          ctx.arc(zonePos.x * canvas.width, zonePos.y * canvas.height, canvas.width * 0.25, 0, Math.PI * 2);
          ctx.strokeStyle = 'rgba(6, 182, 212, 0.6)';
          ctx.lineWidth = 3;
          ctx.setLineDash([10, 5]);
          ctx.stroke();
          ctx.setLineDash([]);

          // Zone center marker
          ctx.beginPath();
          ctx.arc(zonePos.x * canvas.width, zonePos.y * canvas.height, 10, 0, Math.PI * 2);
          ctx.fillStyle = '#06b6d4';
          ctx.fill();
        }
      }

      // Draw player position
      if (currentPos) {
        const pos = gridToPosition(currentPos);
        if (pos) {
          ctx.beginPath();
          ctx.arc(pos.x * canvas.width, pos.y * canvas.height, 12, 0, Math.PI * 2);
          ctx.fillStyle = '#10b981';
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 3;
          ctx.stroke();

          // Draw route line
          if (zoneCenter) {
            const zonePos = gridToPosition(zoneCenter);
            if (zonePos) {
              ctx.beginPath();
              ctx.moveTo(pos.x * canvas.width, pos.y * canvas.height);
              ctx.lineTo(zonePos.x * canvas.width, zonePos.y * canvas.height);
              ctx.strokeStyle = '#6366f1';
              ctx.lineWidth = 3;
              ctx.setLineDash([8, 4]);
              ctx.stroke();
              ctx.setLineDash([]);
            }
          }
        }
      }
    }

    function gridToPosition(grid) {
      const match = grid.match(/([A-H])([1-8])/i);
      if (!match) return null;
      const col = match[1].toUpperCase().charCodeAt(0) - 65;
      const row = parseInt(match[2]) - 1;
      return { x: (col + 0.5) / 8, y: (row + 0.5) / 8 };
    }

    // Click handler for rotation map
    document.getElementById('rotationMapCanvas')?.addEventListener('click', function(e) {
      const rect = this.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top) / rect.height;

      const col = String.fromCharCode(65 + Math.floor(x * 8));
      const row = Math.floor(y * 8) + 1;
      const grid = col + row;

      document.getElementById('currentPosition').value = grid;
      drawRotationMap(grid, document.getElementById('zoneCenter').value);
    });

    // Drop Explorer
    function filterDrops() {
      const style = document.getElementById('styleFilter').value;
      const type = document.getElementById('typeFilter').value;
      const sort = document.getElementById('sortFilter').value;

      let allPOIs = [...POI_DATA.named_pois, ...POI_DATA.landmarks];
      if (type !== 'all') allPOIs = allPOIs.filter(p => p.type === type);

      allPOIs = allPOIs.map(poi => {
        const chests = poi.loot?.chests || 0;
        const rareChests = poi.loot?.rare_chests || 0;
        const shields = (poi.shields?.slurp_barrels || 0) + (poi.shields?.slurp_trucks || 0) * 3 + (poi.shields?.vending_machines || 0);
        const contestMap = { very_low: 10, low: 8, low_medium: 6, medium: 5, high: 2, very_high: 0 };
        const contestScore = contestMap[poi.contest_data?.popularity] || 5;

        let score = style === 'balanced' ? (chests * 0.3) + (rareChests * 0.5) + (shields * 0.2) + (contestScore * 0.5)
                  : style === 'super_safe' ? (chests * 0.15) + (shields * 0.3) + (contestScore * 0.8)
                  : (chests * 0.4) + (rareChests * 0.6) + (shields * 0.15) + (contestScore * 0.2);

        return { ...poi, score: Math.round(score * 100) / 100, shieldScore: shields };
      });

      if (sort === 'score') allPOIs.sort((a, b) => b.score - a.score);
      else if (sort === 'chests') allPOIs.sort((a, b) => b.loot.chests - a.loot.chests);
      else if (sort === 'shields') allPOIs.sort((a, b) => b.shieldScore - a.shieldScore);
      else if (sort === 'contest_low') {
        const order = { very_low: 1, low: 2, low_medium: 3, medium: 4, high: 5, very_high: 6 };
        allPOIs.sort((a, b) => order[a.contest_data?.popularity] - order[b.contest_data?.popularity]);
      }

      const tbody = document.getElementById('poiTableBody');
      tbody.innerHTML = allPOIs.map((poi, i) => {
        const scoreClass = poi.score >= 8 ? 'high' : poi.score >= 5 ? 'medium' : 'low';
        return `<tr>
          <td><strong>#${i + 1}</strong></td>
          <td><span class="poi-name">${poi.name}</span></td>
          <td><span class="poi-type">${poi.type === 'named_poi' ? 'POI' : 'Landmark'}</span></td>
          <td><span class="score-badge ${scoreClass}">${poi.score}</span></td>
          <td>${poi.loot?.chests || 0}</td>
          <td>${poi.shieldScore}</td>
          <td>${(poi.contest_data?.popularity || '').replace('_', ' ')}</td>
          <td><button class="view-btn" onclick="showDropCard('${poi.id}')">View</button></td>
        </tr>`;
      }).join('');
    }

    function showDropCard(poiId) {
      const poi = [...POI_DATA.named_pois, ...POI_DATA.landmarks].find(p => p.id === poiId);
      if (!poi) return;

      const shields = (poi.shields?.slurp_barrels || 0) + (poi.shields?.slurp_trucks || 0) * 3 + (poi.shields?.vending_machines || 0);

      document.getElementById('modalBody').innerHTML = `
        <h2 class="modal-title">${poi.name}</h2>
        <p style="color:var(--text-secondary);margin-bottom:24px;">${poi.description || ''}</p>
        <div class="modal-grid">
          <div class="modal-stat"><div class="modal-stat-label">Chests</div><div class="modal-stat-value">${poi.loot?.chests || 0}</div></div>
          <div class="modal-stat"><div class="modal-stat-label">Rare Chests</div><div class="modal-stat-value">${poi.loot?.rare_chests || 0}</div></div>
          <div class="modal-stat"><div class="modal-stat-label">Shield Score</div><div class="modal-stat-value">${shields}</div></div>
          <div class="modal-stat"><div class="modal-stat-label">Contest</div><div class="modal-stat-value">${(poi.contest_data?.popularity || '').replace('_', ' ')}</div></div>
        </div>
        <div style="margin-top:20px;">
          <h4 style="margin-bottom:12px;">Shield Sources</h4>
          <p>Slurp Barrels: ${poi.shields?.slurp_barrels || 0}</p>
          <p>Slurp Trucks: ${poi.shields?.slurp_trucks || 0}</p>
          <p>Vending Machines: ${poi.shields?.vending_machines || 0}</p>
        </div>
        <div style="margin-top:16px;">
          <h4 style="margin-bottom:12px;">Materials</h4>
          <p>ü™µ Wood: ${poi.materials?.wood || 0}/10</p>
          <p>üß± Brick: ${poi.materials?.brick || 0}/10</p>
          <p>‚öôÔ∏è Metal: ${poi.materials?.metal || 0}/10</p>
        </div>
        <div style="margin-top:24px;">
          <a href="https://fortnite.gg/map" target="_blank" class="btn btn-secondary" style="text-decoration:none;">View on Fortnite.gg ‚Üí</a>
        </div>
      `;
      document.getElementById('modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
    }

    // Map
    const mapLayers = { pois: true, routes: false, zones: false, resources: false };
    let mapImage = null;
    let mapImageLoaded = false;

    // Load the fortnite.gg map image
    function loadMapImage() {
      mapImage = new Image();
      mapImage.crossOrigin = 'anonymous';
      // Use fortnite.gg map tiles - zoom 0 is full map in 256x256
      mapImage.src = 'https://fortnite.gg/maps/39.02/0/0/0.jpg';
      mapImage.onload = () => {
        mapImageLoaded = true;
        drawMap();
        drawRotationMap();
      };
      mapImage.onerror = () => {
        console.log('Map image failed to load, using fallback');
        mapImageLoaded = false;
        drawMap();
      };
    }

    function toggleLayer(layer) {
      mapLayers[layer] = !mapLayers[layer];
      document.getElementById('btn-' + layer).classList.toggle('active');
      drawMap();
    }

    function drawMap() {
      const canvas = document.getElementById('mapCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;

      // Draw fortnite.gg map background if loaded
      if (mapImageLoaded && mapImage) {
        ctx.drawImage(mapImage, 0, 0, canvas.width, canvas.height);
        // Add slight dark overlay for better marker visibility
        ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      } else {
        // Fallback gradient background
        const bg = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width/1.5);
        bg.addColorStop(0, '#1a1a25');
        bg.addColorStop(1, '#0d0d15');
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      // Grid overlay
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 8; i++) {
        ctx.beginPath();
        ctx.moveTo((canvas.width / 8) * i, 0);
        ctx.lineTo((canvas.width / 8) * i, canvas.height);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, (canvas.height / 8) * i);
        ctx.lineTo(canvas.width, (canvas.height / 8) * i);
        ctx.stroke();
      }

      // Grid labels
      ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
      ctx.font = 'bold 12px Inter, sans-serif';
      const letters = 'ABCDEFGH';
      for (let i = 0; i < 8; i++) {
        ctx.fillText(letters[i], (canvas.width / 8) * i + canvas.width / 16 - 4, 15);
        ctx.fillText(i + 1, 5, (canvas.height / 8) * i + canvas.height / 16 + 4);
      }

      if (mapLayers.zones) {
        ctx.beginPath();
        ctx.arc(canvas.width * 0.5, canvas.height * 0.5, canvas.width * 0.35, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(6, 182, 212, 0.5)';
        ctx.lineWidth = 3;
        ctx.setLineDash([10, 5]);
        ctx.stroke();
        ctx.setLineDash([]);
      }

      if (mapLayers.routes) {
        ctx.beginPath();
        ctx.strokeStyle = '#6366f1';
        ctx.lineWidth = 4;
        ctx.setLineDash([12, 6]);
        ctx.moveTo(0.2 * canvas.width, 0.25 * canvas.height);
        ctx.lineTo(0.5 * canvas.width, 0.45 * canvas.height);
        ctx.lineTo(0.55 * canvas.width, 0.7 * canvas.height);
        ctx.stroke();
        ctx.setLineDash([]);
      }

      if (mapLayers.resources) {
        POI_DATA.resources.forEach(res => {
          const [x, y] = res.position;
          const px = x * canvas.width;
          const py = y * canvas.height;

          ctx.beginPath();
          ctx.arc(px, py, 8, 0, Math.PI * 2);
          ctx.fillStyle = res.type === 'slurp_barrel' ? '#06b6d4' :
                          res.type === 'wood_farm' ? '#a0522d' :
                          res.type === 'brick_farm' ? '#cd5c5c' :
                          res.type === 'metal_farm' ? '#708090' :
                          res.type === 'vehicle' ? '#f59e0b' : '#8b5cf6';
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 1;
          ctx.stroke();
        });
      }

      if (mapLayers.pois) {
        [...POI_DATA.named_pois, ...POI_DATA.landmarks].forEach(poi => {
          if (!poi.position) return;
          const [x, y] = poi.position;
          const px = x * canvas.width;
          const py = y * canvas.height;

          const contest = poi.contest_data?.popularity;
          let color = '#f59e0b';
          if (contest === 'very_low' || contest === 'low') color = '#10b981';
          if (contest === 'high' || contest === 'very_high') color = '#ef4444';

          ctx.beginPath();
          ctx.arc(px, py, 20, 0, Math.PI * 2);
          ctx.fillStyle = color + '33';
          ctx.fill();

          ctx.beginPath();
          ctx.arc(px, py, poi.type === 'named_poi' ? 14 : 10, 0, Math.PI * 2);
          ctx.fillStyle = color;
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.stroke();

          ctx.fillStyle = '#fff';
          ctx.font = 'bold 11px Inter, sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(poi.name.split(' ')[0], px, py + 28);
        });
      }
    }

    // Modal close
    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target.id === 'modal') closeModal();
    });

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      filterDrops();
      loadMapImage(); // Load fortnite.gg map
      setTimeout(drawMap, 100);
      setTimeout(drawRotationMap, 100);
      window.addEventListener('resize', () => {
        drawMap();
        drawRotationMap();
      });
    });
  </script>
</body>
</html>
