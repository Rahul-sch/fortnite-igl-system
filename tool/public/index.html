<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IGL Winning System v4.0 - Fortnite Duos Tool</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
  <!-- Leaflet CSS for proper map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --bg-primary: #05050a;
      --bg-secondary: #0d0d15;
      --bg-tertiary: #14141f;
      --bg-card: linear-gradient(145deg, #0d0d15 0%, #14141f 100%);
      --text-primary: #ffffff;
      --text-secondary: #8888aa;
      --accent-primary: #6366f1;
      --accent-secondary: #8b5cf6;
      --accent-tertiary: #a855f7;
      --accent-success: #10b981;
      --accent-warning: #f59e0b;
      --accent-danger: #ef4444;
      --accent-cyan: #06b6d4;
      --border-color: rgba(99, 102, 241, 0.2);
      --glow-primary: rgba(99, 102, 241, 0.4);
      --glow-secondary: rgba(139, 92, 246, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Animated Background */
    .bg-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background:
        radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(6, 182, 212, 0.05) 0%, transparent 70%);
      animation: bgPulse 8s ease-in-out infinite;
    }

    @keyframes bgPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }

    /* Header */
    header {
      text-align: center;
      padding: 40px 20px;
      position: relative;
    }

    .logo {
      display: inline-flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
    }

    .logo-icon {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      box-shadow: 0 0 30px var(--glow-primary);
      animation: logoGlow 3s ease-in-out infinite;
    }

    @keyframes logoGlow {
      0%, 100% { box-shadow: 0 0 30px var(--glow-primary); }
      50% { box-shadow: 0 0 50px var(--glow-secondary), 0 0 80px var(--glow-primary); }
    }

    header h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.8rem;
      font-weight: 900;
      background: linear-gradient(135deg, #fff 0%, var(--accent-primary) 50%, var(--accent-tertiary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 2px;
      text-shadow: 0 0 40px var(--glow-primary);
    }

    .subtitle {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .subtitle-badge {
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 30px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .subtitle-badge .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-success);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    /* Stats Bar */
    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin: 30px 0;
      padding: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      flex-wrap: wrap;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-primary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 4px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 25px;
      padding: 8px;
      background: var(--bg-secondary);
      border-radius: 16px;
      border: 1px solid var(--border-color);
    }

    .tab {
      flex: 1;
      padding: 14px 20px;
      background: transparent;
      border: none;
      border-radius: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 600;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .tab:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .tab.active {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      box-shadow: 0 4px 20px var(--glow-primary);
    }

    .tab-icon {
      font-size: 1.2rem;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent-primary), var(--accent-secondary), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .card:hover::before {
      opacity: 1;
    }

    .card:hover {
      border-color: rgba(99, 102, 241, 0.4);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .card-icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 20px;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 18px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 4px var(--glow-primary);
    }

    .form-group select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%238888aa'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px;
      padding-right: 40px;
    }

    /* Materials Input */
    .mats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .mat-input {
      text-align: center;
      padding: 16px 12px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      transition: all 0.3s;
    }

    .mat-input:hover {
      border-color: var(--border-color);
    }

    .mat-input.wood { border-color: rgba(160, 82, 45, 0.5); }
    .mat-input.wood:hover { border-color: #a0522d; box-shadow: 0 0 20px rgba(160, 82, 45, 0.2); }
    .mat-input.brick { border-color: rgba(205, 92, 92, 0.5); }
    .mat-input.brick:hover { border-color: #cd5c5c; box-shadow: 0 0 20px rgba(205, 92, 92, 0.2); }
    .mat-input.metal { border-color: rgba(112, 128, 144, 0.5); }
    .mat-input.metal:hover { border-color: #708090; box-shadow: 0 0 20px rgba(112, 128, 144, 0.2); }

    .mat-input label {
      display: block;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .mat-input.wood label { color: #d4a574; }
    .mat-input.brick label { color: #e8a0a0; }
    .mat-input.metal label { color: #a0b0c0; }

    .mat-input input {
      width: 100%;
      padding: 10px;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 1.4rem;
      font-weight: 700;
      text-align: center;
      font-family: 'Orbitron', sans-serif;
    }

    .mat-input input:focus {
      outline: none;
    }

    /* Buttons */
    .btn {
      padding: 16px 32px;
      font-size: 1rem;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      box-shadow: 0 4px 20px var(--glow-primary);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 30px var(--glow-primary), 0 0 60px var(--glow-secondary);
    }

    .btn-primary:active {
      transform: translateY(-1px);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
    }

    .btn-secondary:hover {
      border-color: var(--accent-primary);
      box-shadow: 0 0 20px var(--glow-primary);
    }

    .analyze-section {
      text-align: center;
      margin: 30px 0;
    }

    .btn-analyze {
      padding: 20px 60px;
      font-size: 1.1rem;
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 50%, var(--accent-tertiary) 100%);
      background-size: 200% 200%;
      animation: gradientShift 3s ease infinite;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Results Panel */
    .results-panel {
      background: var(--bg-card);
      border: 2px solid var(--accent-primary);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 0 40px var(--glow-primary);
      animation: resultsPop 0.4s ease;
    }

    @keyframes resultsPop {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .result-section {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border-color);
    }

    .result-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .result-section h3 {
      font-size: 0.9rem;
      color: var(--accent-primary);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 2px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .recommendation {
      background: var(--bg-primary);
      padding: 18px;
      border-radius: 12px;
      margin-bottom: 12px;
      border-left: 4px solid var(--border-color);
      transition: all 0.3s;
    }

    .recommendation:hover {
      transform: translateX(5px);
    }

    .recommendation.now {
      border-left-color: var(--accent-danger);
      background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), transparent);
    }

    .recommendation.safe {
      border-left-color: var(--accent-success);
      background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), transparent);
    }

    .recommendation.warning {
      border-left-color: var(--accent-warning);
      background: linear-gradient(90deg, rgba(245, 158, 11, 0.1), transparent);
    }

    .recommendation strong {
      font-size: 1.1rem;
      display: block;
      margin-bottom: 8px;
    }

    .priority-list {
      list-style: none;
      counter-reset: priority;
    }

    .priority-list li {
      padding: 14px 18px;
      background: var(--bg-primary);
      margin-bottom: 8px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 14px;
      transition: all 0.3s;
      counter-increment: priority;
    }

    .priority-list li:hover {
      transform: translateX(5px);
      background: var(--bg-tertiary);
    }

    .priority-list li::before {
      content: counter(priority);
      min-width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 700;
    }

    .path-card {
      background: var(--bg-primary);
      padding: 18px;
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid var(--border-color);
      transition: all 0.3s;
    }

    .path-card:hover {
      border-color: var(--accent-primary);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .path-card h4 {
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .risk-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .risk-badge.low {
      background: rgba(16, 185, 129, 0.2);
      color: var(--accent-success);
      border: 1px solid rgba(16, 185, 129, 0.4);
    }

    .risk-badge.medium {
      background: rgba(245, 158, 11, 0.2);
      color: var(--accent-warning);
      border: 1px solid rgba(245, 158, 11, 0.4);
    }

    .risk-badge.high {
      background: rgba(239, 68, 68, 0.2);
      color: var(--accent-danger);
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

    /* Loading */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px;
      gap: 20px;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--bg-tertiary);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: var(--text-secondary);
      font-size: 0.9rem;
      animation: loadingPulse 1.5s ease-in-out infinite;
    }

    @keyframes loadingPulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    /* API Key Section */
    .api-section {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.05));
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .api-section input {
      font-family: 'SF Mono', 'Fira Code', monospace;
    }

    .api-hint {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .api-hint a {
      color: var(--accent-primary);
      text-decoration: none;
      font-weight: 600;
    }

    .api-hint a:hover {
      text-decoration: underline;
    }

    /* Drop Explorer */
    .filter-bar {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filter-group label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
    }

    .filter-group select {
      padding: 10px 36px 10px 14px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .filter-group select:hover {
      border-color: var(--accent-primary);
    }

    /* POI Table */
    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .poi-table {
      width: 100%;
      border-collapse: collapse;
    }

    .poi-table th,
    .poi-table td {
      padding: 16px;
      text-align: left;
    }

    .poi-table th {
      background: var(--bg-primary);
      color: var(--text-secondary);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
      border-bottom: 2px solid var(--border-color);
      cursor: pointer;
      transition: color 0.3s;
    }

    .poi-table th:hover {
      color: var(--accent-primary);
    }

    .poi-table tr {
      border-bottom: 1px solid var(--border-color);
      transition: all 0.3s;
    }

    .poi-table tbody tr:hover {
      background: var(--bg-tertiary);
    }

    .poi-name {
      font-weight: 700;
      font-size: 1rem;
    }

    .poi-type {
      font-size: 0.8rem;
      color: var(--text-secondary);
      padding: 4px 10px;
      background: var(--bg-primary);
      border-radius: 20px;
      display: inline-block;
    }

    .score-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 50px;
      padding: 8px 14px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 0.95rem;
      font-family: 'Orbitron', sans-serif;
    }

    .score-badge.high {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
      color: var(--accent-success);
      border: 1px solid rgba(16, 185, 129, 0.4);
    }

    .score-badge.medium {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
      color: var(--accent-warning);
      border: 1px solid rgba(245, 158, 11, 0.4);
    }

    .score-badge.low {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
      color: var(--accent-danger);
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

    .view-btn {
      padding: 8px 16px;
      font-size: 0.8rem;
      background: transparent;
      border: 2px solid var(--accent-primary);
      color: var(--accent-primary);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .view-btn:hover {
      background: var(--accent-primary);
      color: white;
      box-shadow: 0 0 20px var(--glow-primary);
    }

    /* Map Container */
    .map-container {
      position: relative;
      background: var(--bg-primary);
      border-radius: 16px;
      overflow: hidden;
      aspect-ratio: 1;
      max-height: 650px;
      border: 2px solid var(--border-color);
    }

    .map-canvas {
      width: 100%;
      height: 100%;
      cursor: crosshair;
    }

    .map-controls {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .map-controls button {
      padding: 10px 16px;
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.3s;
    }

    .map-controls button:hover {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
    }

    .map-controls button.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
    }

    .map-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 16px;
      padding: 16px;
      background: var(--bg-tertiary);
      border-radius: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .legend-color {
      width: 18px;
      height: 18px;
      border-radius: 6px;
      box-shadow: 0 0 10px currentColor;
    }

    /* Rotation Planner Specific */
    .rotation-planner-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 1100px) {
      .rotation-planner-grid {
        grid-template-columns: 1fr;
      }
    }

    .position-input-group {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .position-coord {
      flex: 1;
      text-align: center;
    }

    .position-coord input {
      width: 100%;
      padding: 12px;
      font-size: 1.2rem;
      font-family: 'Orbitron', sans-serif;
      text-align: center;
    }

    .position-coord label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .route-info-panel {
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-color);
      max-height: 400px;
      overflow-y: auto;
    }

    .route-waypoint {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      margin-bottom: 10px;
      border-left: 4px solid var(--accent-primary);
    }

    .route-waypoint.resource {
      border-left-color: var(--accent-success);
    }

    .route-waypoint.danger {
      border-left-color: var(--accent-danger);
    }

    .route-waypoint-icon {
      font-size: 1.5rem;
      min-width: 40px;
      text-align: center;
    }

    .route-waypoint-info h4 {
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .route-waypoint-info p {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .refarm-badge {
      display: inline-block;
      padding: 4px 10px;
      background: rgba(16, 185, 129, 0.2);
      color: var(--accent-success);
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 700;
      margin-left: 8px;
    }

    .danger-badge {
      display: inline-block;
      padding: 4px 10px;
      background: rgba(239, 68, 68, 0.2);
      color: var(--accent-danger);
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 700;
      margin-left: 8px;
    }

    .team-prediction-card {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(245, 158, 11, 0.05));
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .team-prediction-card h4 {
      color: var(--accent-danger);
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .prediction-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .prediction-item:last-child {
      border-bottom: none;
    }

    .prediction-chance {
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
    }

    .prediction-chance.high {
      color: var(--accent-danger);
    }

    .prediction-chance.medium {
      color: var(--accent-warning);
    }

    .prediction-chance.low {
      color: var(--accent-success);
    }

    /* Click marker styles */
    .click-position {
      position: absolute;
      pointer-events: none;
      font-size: 0.7rem;
      padding: 4px 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--accent-primary);
      border-radius: 6px;
      color: var(--accent-primary);
      white-space: nowrap;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
      animation: modalFade 0.3s ease;
    }

    @keyframes modalFade {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: var(--bg-secondary);
      border: 2px solid var(--accent-primary);
      border-radius: 20px;
      max-width: 700px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      padding: 32px;
      position: relative;
      box-shadow: 0 0 60px var(--glow-primary);
      animation: modalPop 0.3s ease;
    }

    @keyframes modalPop {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 40px;
      height: 40px;
      background: var(--bg-tertiary);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .modal-close:hover {
      background: var(--accent-danger);
      border-color: var(--accent-danger);
    }

    .modal-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.8rem;
      margin-bottom: 24px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .modal-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    .modal-stat {
      background: var(--bg-primary);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .modal-stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .modal-stat-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--accent-cyan);
    }

    /* SURPRISE FEATURES STYLES */

    /* Smart Notification */
    .smart-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      background: var(--bg-secondary);
      border: 2px solid var(--accent-primary);
      border-radius: 12px;
      color: white;
      font-weight: 600;
      z-index: 10000;
      transform: translateX(120%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      max-width: 400px;
    }

    .smart-notification.show {
      transform: translateX(0);
    }

    .smart-notification.success {
      border-color: var(--accent-success);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), var(--bg-secondary));
    }

    .smart-notification.info {
      border-color: var(--accent-cyan);
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), var(--bg-secondary));
    }

    /* Coach Tip Popup */
    .coach-tip-popup {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 24px;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.95), rgba(139, 92, 246, 0.95));
      border-radius: 16px;
      z-index: 9999;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 20px 60px rgba(99, 102, 241, 0.4);
      max-width: 500px;
    }

    .coach-tip-popup.show {
      transform: translateX(-50%) translateY(0);
    }

    .coach-avatar {
      font-size: 2rem;
      animation: coachBounce 1s ease-in-out infinite;
    }

    @keyframes coachBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    .coach-message {
      font-size: 1rem;
      font-weight: 600;
      line-height: 1.4;
    }

    /* Tournament Mode Display */
    .tourney-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-weight: 700;
    }

    .tourney-progress {
      height: 8px;
      background: var(--bg-primary);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .tourney-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-success), var(--accent-cyan));
      transition: width 0.5s ease;
    }

    /* Feature Buttons Grid */
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .feature-btn {
      padding: 12px 16px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .feature-btn:hover {
      border-color: var(--accent-primary);
      background: var(--bg-tertiary);
      transform: translateY(-2px);
    }

    .feature-btn.active {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-color: transparent;
    }

    /* Keyboard hint styling */
    kbd {
      display: inline-block;
      padding: 3px 8px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-family: 'Orbitron', monospace;
      font-size: 0.75rem;
      color: var(--accent-primary);
    }

    /* Bus Path Controls */
    .bus-path-controls {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .bus-input-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .bus-input-group label {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .bus-input-group input {
      padding: 10px 14px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      font-family: 'Orbitron', monospace;
      width: 120px;
      text-transform: uppercase;
    }

    .bus-input-group input:focus {
      outline: none;
      border-color: var(--accent-primary);
    }

    /* Leaflet map overrides */
    .leaflet-container {
      background: #1a1a25 !important;
    }

    .leaflet-control-zoom a {
      background: var(--bg-secondary) !important;
      color: white !important;
      border-color: var(--border-color) !important;
    }

    .leaflet-control-zoom a:hover {
      background: var(--accent-primary) !important;
    }

    .poi-marker {
      background: transparent;
      border: none;
    }

    .poi-label {
      color: white;
      font-weight: 700;
      text-shadow: 0 0 4px black, 0 0 4px black;
      font-size: 11px;
      white-space: nowrap;
    }

    .chest-marker {
      width: 20px;
      height: 20px;
      background: #fbbf24;
      border: 2px solid #000;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      color: black;
    }

    .ammo-marker {
      width: 18px;
      height: 18px;
      background: #22c55e;
      border: 2px solid #000;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: bold;
      color: black;
    }

    .bus-drop-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 4px solid var(--accent-success);
    }

    .bus-drop-item.contested {
      border-left-color: var(--accent-warning);
    }

    .bus-drop-item.hot {
      border-left-color: var(--accent-danger);
    }

    .drop-distance {
      font-family: 'Orbitron', monospace;
      color: var(--accent-cyan);
      font-size: 0.9rem;
    }

    /* Disclaimer */
    .disclaimer {
      background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), rgba(245, 158, 11, 0.05));
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 24px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .disclaimer-icon {
      font-size: 1.5rem;
      line-height: 1;
    }

    .disclaimer-text {
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .disclaimer-text strong {
      color: var(--accent-danger);
    }

    /* Responsive */
    @media (max-width: 768px) {
      header h1 {
        font-size: 1.8rem;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .tabs {
        flex-direction: column;
      }

      .stats-bar {
        gap: 20px;
      }

      .filter-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .modal-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Map Layer Toggles - fortnite.gg style */
    .layer-toggles {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      padding: 12px;
      background: var(--bg-primary);
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .layer-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .layer-toggle:hover {
      border-color: var(--accent-primary);
    }

    .layer-toggle.active {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-color: transparent;
      color: white;
    }

    .layer-toggle-icon {
      font-size: 1rem;
    }

    /* Pro Heatmap overlay */
    .heatmap-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0.6;
    }

    /* Live Game Tracker */
    .live-tracker {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(6, 182, 212, 0.05));
      border: 2px solid var(--accent-danger);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      animation: livePulse 2s ease-in-out infinite;
    }

    @keyframes livePulse {
      0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.3); }
      50% { box-shadow: 0 0 40px rgba(239, 68, 68, 0.5); }
    }

    .live-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      background: var(--accent-danger);
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
    }

    /* Voice Comms Panel */
    .voice-panel {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }

    .voice-command {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-primary);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .voice-command:hover {
      background: var(--bg-tertiary);
      transform: translateX(4px);
    }

    .voice-key {
      min-width: 40px;
      height: 40px;
      background: var(--accent-primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
    }

    /* Win Probability Meter */
    .win-meter {
      height: 20px;
      background: var(--bg-primary);
      border-radius: 10px;
      overflow: hidden;
      margin: 12px 0;
      position: relative;
    }

    .win-meter-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-danger), var(--accent-warning), var(--accent-success));
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    .win-meter-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.75rem;
      font-weight: 700;
      text-shadow: 0 0 4px black;
    }

    /* Session Stats */
    .session-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin: 16px 0;
    }

    .session-stat {
      background: var(--bg-tertiary);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .session-stat-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-primary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .session-stat-label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-top: 4px;
    }

    /* Hotkey Hints */
    .hotkey-hint {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.7rem;
      color: var(--text-secondary);
      margin-left: 8px;
    }

    .hotkey-hint kbd {
      background: var(--bg-primary);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }

    /* Timeline */
    .game-timeline {
      position: relative;
      padding: 20px 0;
    }

    .timeline-line {
      position: absolute;
      top: 0;
      left: 20px;
      width: 2px;
      height: 100%;
      background: var(--border-color);
    }

    .timeline-event {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 16px;
      padding-left: 50px;
      position: relative;
    }

    .timeline-dot {
      position: absolute;
      left: 12px;
      width: 18px;
      height: 18px;
      background: var(--accent-primary);
      border-radius: 50%;
      border: 3px solid var(--bg-primary);
    }

    .timeline-dot.kill { background: var(--accent-danger); }
    .timeline-dot.zone { background: var(--accent-cyan); }
    .timeline-dot.loot { background: var(--accent-warning); }

    /* Floating Action Button */
    .fab {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 4px 20px var(--glow-primary);
      transition: all 0.3s;
      z-index: 100;
      border: none;
      color: white;
    }

    .fab:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 30px var(--glow-primary);
    }

    /* Quick Actions Menu */
    .quick-actions {
      position: fixed;
      bottom: 100px;
      right: 30px;
      display: none;
      flex-direction: column;
      gap: 10px;
      z-index: 99;
    }

    .quick-actions.active {
      display: flex;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .quick-action-btn {
      width: 50px;
      height: 50px;
      background: var(--bg-secondary);
      border: 2px solid var(--accent-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
      color: white;
    }

    .quick-action-btn:hover {
      background: var(--accent-primary);
      transform: scale(1.1);
    }

    /* Compact Mode */
    .compact .card {
      padding: 12px;
    }

    .compact .form-group {
      margin-bottom: 10px;
    }

    /* Sound Effects Toggle */
    .sound-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      transition: all 0.2s;
    }

    .sound-toggle:hover {
      border-color: var(--accent-primary);
    }

    /* Confetti Canvas */
    #confetti-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div class="bg-animation"></div>

  <div class="container">
    <header>
      <div class="logo">
        <div class="logo-icon">üéÆ</div>
        <h1>IGL SYSTEM</h1>
      </div>
      <div class="subtitle">
        <span class="subtitle-badge"><span class="dot"></span> NAC Region</span>
        <span class="subtitle-badge">Chapter 7 S1</span>
        <span class="subtitle-badge">35-45ms Ping</span>
        <span class="subtitle-badge">Duos Builds</span>
      </div>
    </header>

    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value">13</div>
        <div class="stat-label">Named POIs</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">10+</div>
        <div class="stat-label">Landmarks</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">3</div>
        <div class="stat-label">Drop Styles</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">AI</div>
        <div class="stat-label">Powered</div>
      </div>
    </div>

    <div class="disclaimer">
      <span class="disclaimer-icon">‚ö†Ô∏è</span>
      <div class="disclaimer-text">
        <strong>FAIR PLAY:</strong> This tool uses ONLY manual user inputs. No memory reading, no overlays, no automation. All advice is based on public map data and competitive macro principles.
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="analyzer">
        <span class="tab-icon">üéØ</span>
        <span>Analyzer</span>
      </button>
      <button class="tab" data-tab="rotation">
        <span class="tab-icon">üõ§Ô∏è</span>
        <span>Rotation</span>
      </button>
      <button class="tab" data-tab="drops">
        <span class="tab-icon">üìç</span>
        <span>Drops</span>
      </button>
      <button class="tab" data-tab="map">
        <span class="tab-icon">üó∫Ô∏è</span>
        <span>Map</span>
      </button>
      <button class="tab" data-tab="analytics">
        <span class="tab-icon">üìä</span>
        <span>Analytics</span>
      </button>
    </div>

    <!-- ANALYZER TAB -->
    <div id="analyzer" class="tab-content active">
      <div class="api-section">
        <div class="form-group" style="margin-bottom: 0;">
          <label>Groq API Key</label>
          <input type="password" id="apiKey" placeholder="Enter your API key (gsk_...)" />
          <div class="api-hint">
            <span>üîë</span>
            <span>Get a free key at <a href="https://console.groq.com" target="_blank">console.groq.com</a></span>
          </div>
        </div>
      </div>

      <div class="grid">
        <div>
          <div class="card">
            <div class="card-header">
              <div class="card-icon">üìç</div>
              <div class="card-title">Location & Contest</div>
            </div>
            <div class="form-group">
              <label>Landing Spot</label>
              <select id="landingSpot">
                <option value="">-- Select POI --</option>
                <optgroup label="Named POIs">
                  <option value="Battle Boulevard">Battle Boulevard</option>
                  <option value="Sandy Strip">Sandy Strip</option>
                  <option value="Tiptop Terrace">Tiptop Terrace</option>
                  <option value="Painted Palms">Painted Palms</option>
                  <option value="Bumpy Bay">Bumpy Bay</option>
                  <option value="Innoloop Labs">Innoloop Labs</option>
                  <option value="Fore Fields">Fore Fields</option>
                  <option value="Ripped Tides">Ripped Tides</option>
                  <option value="Sus Studios">Sus Studios</option>
                  <option value="Wonkeeland / Cartmanland">Wonkeeland / Cartmanland</option>
                  <option value="Classified Canyon">Classified Canyon</option>
                  <option value="Humble Hills">Humble Hills</option>
                  <option value="Fore Shores">Fore Shores</option>
                </optgroup>
                <optgroup label="Landmarks">
                  <option value="Toybox Docks">Toybox Docks</option>
                  <option value="Artsy RVs">Artsy RVs</option>
                  <option value="Peelian Swamp">Peelian Swamp</option>
                  <option value="Storm Station">Storm Station</option>
                  <option value="Paws Inn">Paws Inn / Clawsy Lodge</option>
                </optgroup>
              </select>
            </div>
            <div class="form-group">
              <label>Teams at Drop</label>
              <select id="teamsContested">
                <option value="1">1 - Uncontested ‚úÖ</option>
                <option value="2">2 - One other team</option>
                <option value="3">3 - Two other teams</option>
                <option value="4+">4+ - Multi-team chaos üî•</option>
              </select>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-icon">üéí</div>
              <div class="card-title">Current Loadout</div>
            </div>
            <div class="form-group">
              <label>Weapons</label>
              <input type="text" id="weapons" placeholder="e.g., Gold AR, Blue Pump, SMG" />
            </div>
            <div class="form-group">
              <label>Heals</label>
              <input type="text" id="heals" placeholder="e.g., 6 minis, 2 medkits" />
            </div>
            <div class="form-group">
              <label>Shield Status</label>
              <select id="shields">
                <option value="full">Full Shield (200 HP) üí™</option>
                <option value="half">Half Shield (~150 HP)</option>
                <option value="low">Low Shield (~100 HP)</option>
                <option value="none">No Shield (75 HP) ‚ö†Ô∏è</option>
              </select>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-icon">ü™µ</div>
              <div class="card-title">Materials</div>
            </div>
            <div class="mats-grid">
              <div class="mat-input wood">
                <label>Wood</label>
                <input type="number" id="matsWood" min="0" max="999" value="300" />
              </div>
              <div class="mat-input brick">
                <label>Brick</label>
                <input type="number" id="matsBrick" min="0" max="999" value="200" />
              </div>
              <div class="mat-input metal">
                <label>Metal</label>
                <input type="number" id="matsMetal" min="0" max="999" value="100" />
              </div>
            </div>
          </div>
        </div>

        <div>
          <div class="card">
            <div class="card-header">
              <div class="card-icon">üåÄ</div>
              <div class="card-title">Storm & Zone</div>
            </div>
            <div class="form-group">
              <label>Storm Pull Direction</label>
              <select id="stormDirection">
                <option value="toward_us">Toward Us (Good) ‚úÖ</option>
                <option value="neutral">Neutral (Moderate)</option>
                <option value="away">Away From Us (Bad) ‚ö†Ô∏è</option>
                <option value="opposite_corner">Opposite Corner (Worst) üö®</option>
              </select>
            </div>
            <div class="form-group">
              <label>Distance to Safe Zone</label>
              <select id="stormDistance">
                <option value="close">Close (1-3 tiles)</option>
                <option value="medium">Medium (4-7 tiles)</option>
                <option value="far">Far (8-12 tiles)</option>
                <option value="very_far">Very Far (13+ tiles) üèÉ</option>
              </select>
            </div>
            <div class="form-group">
              <label>Current Zone / Time</label>
              <input type="text" id="timeZone" placeholder="e.g., Storm 2, 1:30 remaining" />
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-icon">‚ö°</div>
              <div class="card-title">Surge Status</div>
            </div>
            <div class="form-group">
              <label>Surge Position</label>
              <select id="surgeStatus">
                <option value="ahead_10+">10+ Above (Safe) ‚úÖ</option>
                <option value="ahead_5">5-10 Above (Comfortable)</option>
                <option value="even">Even / Slightly Above</option>
                <option value="behind_5">5-10 Below (Need Tags) ‚ö†Ô∏è</option>
                <option value="behind_10+">10+ Below (Critical) üö®</option>
              </select>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-icon">üìù</div>
              <div class="card-title">Extra Context</div>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <textarea id="additionalContext" rows="3" placeholder="Any other info (teammate low, vehicle nearby, team watching us...)"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="analyze-section">
        <button class="btn btn-primary btn-analyze" id="analyzeBtn" onclick="analyzeGame()">
          <span>üéØ</span>
          <span>ANALYZE SITUATION</span>
        </button>
      </div>

      <div id="resultsPanel" class="results-panel" style="display: none;">
        <div id="loadingIndicator" class="loading">
          <div class="spinner"></div>
          <div class="loading-text">Analyzing your situation...</div>
        </div>
        <div id="analysisResults"></div>
      </div>
    </div>

    <!-- ROTATION PLANNER TAB -->
    <div id="rotation" class="tab-content">
      <div class="rotation-planner-grid">
        <div>
          <div class="card">
            <div class="card-header">
              <div class="card-icon">üìç</div>
              <div class="card-title">Your Current Position</div>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.9rem;">Click on the map or enter grid coordinates (A1-H8)</p>
            <div class="form-group">
              <label>Grid Position</label>
              <input type="text" id="currentPosition" placeholder="e.g., D5, E3" />
            </div>
            <div class="form-group">
              <label>Current POI (optional)</label>
              <select id="currentPOI">
                <option value="">-- Select if at POI --</option>
                <option value="Battle Boulevard">Battle Boulevard</option>
                <option value="Sandy Strip">Sandy Strip</option>
                <option value="Tiptop Terrace">Tiptop Terrace</option>
                <option value="Painted Palms">Painted Palms</option>
                <option value="Bumpy Bay">Bumpy Bay</option>
                <option value="Innoloop Labs">Innoloop Labs</option>
                <option value="Ripped Tides">Ripped Tides</option>
                <option value="Classified Canyon">Classified Canyon</option>
                <option value="Toybox Docks">Toybox Docks</option>
                <option value="Artsy RVs">Artsy RVs</option>
              </select>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-icon">üåÄ</div>
              <div class="card-title">Zone Information</div>
            </div>
            <div class="form-group">
              <label>Zone Center Grid</label>
              <input type="text" id="zoneCenter" placeholder="e.g., E4" />
            </div>
            <div class="form-group">
              <label>Current Zone</label>
              <select id="currentZone">
                <option value="1">Zone 1 (Huge)</option>
                <option value="2">Zone 2</option>
                <option value="3">Zone 3</option>
                <option value="4">Zone 4 (Half-half)</option>
                <option value="5">Zone 5 (Moving)</option>
                <option value="6">Zone 6 (Endgame)</option>
                <option value="7">Zone 7+ (Heal-off)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Teams Alive</label>
              <select id="teamsAlive">
                <option value="40+">40+ Teams</option>
                <option value="30-40">30-40 Teams</option>
                <option value="20-30">20-30 Teams</option>
                <option value="15-20">15-20 Teams</option>
                <option value="10-15">10-15 Teams</option>
                <option value="5-10">5-10 Teams</option>
                <option value="1-5">1-5 Teams</option>
              </select>
            </div>
          </div>

          <div class="analyze-section" style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="planRotation()">
              <span>üõ§Ô∏è</span>
              <span>PLAN ROTATION</span>
            </button>
          </div>
        </div>

        <div>
          <div class="card" style="height: 100%;">
            <div class="card-header">
              <div class="card-icon">üó∫Ô∏è</div>
              <div class="card-title">Interactive Map - Click to Set Position</div>
            </div>
            <div class="map-container" style="max-height: 400px;">
              <canvas id="rotationMapCanvas" class="map-canvas"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div id="rotationResults" style="display: none; margin-top: 20px;">
        <div class="grid">
          <div class="card">
            <div class="card-header">
              <div class="card-icon">üë•</div>
              <div class="card-title">Team Position Predictions</div>
            </div>
            <div class="team-prediction-card">
              <h4>‚ö†Ô∏è Likely Enemy Positions</h4>
              <div id="teamPredictions"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-icon">üõ§Ô∏è</div>
              <div class="card-title">Optimal Route</div>
            </div>
            <div id="optimalRoute" class="route-info-panel"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon">üì¶</div>
            <div class="card-title">Resources Along Route</div>
          </div>
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
            <div id="refarmSpots"></div>
            <div id="dangerZones"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- DROPS TAB -->
    <div id="drops" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-icon">üîç</div>
          <div class="card-title">Filter & Sort</div>
        </div>
        <div class="filter-bar">
          <div class="filter-group">
            <label>Style:</label>
            <select id="styleFilter" onchange="filterDrops()">
              <option value="balanced">Balanced</option>
              <option value="super_safe">Super Safe</option>
              <option value="risky_keying">Risky / Keying</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Type:</label>
            <select id="typeFilter" onchange="filterDrops()">
              <option value="all">All Locations</option>
              <option value="named_poi">Named POIs</option>
              <option value="landmark">Landmarks</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Sort:</label>
            <select id="sortFilter" onchange="filterDrops()">
              <option value="score">Score (High‚ÜíLow)</option>
              <option value="chests">Chests</option>
              <option value="shields">Shields</option>
              <option value="contest_low">Lowest Contest</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-icon">üìä</div>
          <div class="card-title">POI Rankings</div>
        </div>
        <div class="table-container">
          <table class="poi-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Location</th>
                <th>Type</th>
                <th>Score</th>
                <th>Chests</th>
                <th>Shields</th>
                <th>Contest</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="poiTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- MAP TAB -->
    <div id="map" class="tab-content">
      <!-- Bus Path Input -->
      <div class="card" style="margin-bottom: 16px;">
        <div class="card-header">
          <div class="card-icon">üöå</div>
          <div class="card-title">Bus Path</div>
        </div>
        <div class="bus-path-controls">
          <div class="bus-input-group">
            <label>Bus Start (click map or enter grid)</label>
            <input type="text" id="busStart" placeholder="e.g., A3, H5" onchange="updateBusPath()" />
          </div>
          <div class="bus-input-group">
            <label>Bus End (click map or enter grid)</label>
            <input type="text" id="busEnd" placeholder="e.g., H6, B8" onchange="updateBusPath()" />
          </div>
          <div class="bus-input-group">
            <button class="btn btn-secondary" onclick="clearBusPath()" style="padding: 10px 20px;">Clear</button>
            <button class="btn btn-primary" onclick="analyzeBusPath()" style="padding: 10px 20px;">Analyze Drops</button>
          </div>
        </div>
        <div id="busAnalysis" style="display: none; margin-top: 16px; padding: 16px; background: var(--bg-primary); border-radius: 12px;">
          <h4 style="margin-bottom: 12px; color: var(--accent-cyan);">üéØ Recommended Drops for This Bus</h4>
          <div id="busDropRecommendations"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-icon">üó∫Ô∏è</div>
          <div class="card-title">Interactive Map (Fortnite.gg Tiles)</div>
          <span style="margin-left: auto; font-size: 0.8rem; color: var(--text-secondary);">Click to set bus path ‚Ä¢ Scroll to zoom</span>
        </div>

        <!-- Fortnite.gg Style Layer Toggles -->
        <div class="layer-toggles">
          <div class="layer-toggle active" onclick="toggleMapLayer('pois')" id="toggle-pois">
            <span class="layer-toggle-icon">üìç</span> POIs
          </div>
          <div class="layer-toggle active" onclick="toggleMapLayer('chests')" id="toggle-chests">
            <span class="layer-toggle-icon">üì¶</span> Chests
          </div>
          <div class="layer-toggle active" onclick="toggleMapLayer('ammo')" id="toggle-ammo">
            <span class="layer-toggle-icon">üî´</span> Ammo
          </div>
          <div class="layer-toggle" onclick="toggleMapLayer('vending')" id="toggle-vending">
            <span class="layer-toggle-icon">üèß</span> Vending
          </div>
          <div class="layer-toggle" onclick="toggleMapLayer('mending')" id="toggle-mending">
            <span class="layer-toggle-icon">üíä</span> Mending
          </div>
          <div class="layer-toggle" onclick="toggleMapLayer('vehicles')" id="toggle-vehicles">
            <span class="layer-toggle-icon">üöó</span> Cars
          </div>
          <div class="layer-toggle" onclick="toggleMapLayer('ziplines')" id="toggle-ziplines">
            <span class="layer-toggle-icon">üéø</span> Ziplines
          </div>
          <div class="layer-toggle" onclick="toggleMapLayer('campfires')" id="toggle-campfires">
            <span class="layer-toggle-icon">üî•</span> Campfires
          </div>
          <div class="layer-toggle" onclick="toggleMapLayer('reboot')" id="toggle-reboot">
            <span class="layer-toggle-icon">üíö</span> Reboot
          </div>
          <div class="layer-toggle" onclick="toggleMapLayer('launchpads')" id="toggle-launchpads">
            <span class="layer-toggle-icon">üöÄ</span> Launch Pads
          </div>
          <div class="layer-toggle" onclick="toggleMapLayer('portapotty')" id="toggle-portapotty">
            <span class="layer-toggle-icon">üöΩ</span> Port-a-Potty
          </div>
          <div class="layer-toggle active" onclick="toggleMapLayer('busPath')" id="toggle-busPath">
            <span class="layer-toggle-icon">üöå</span> Bus Path
          </div>
        </div>

        <!-- Leaflet Map Container -->
        <div id="leafletMap" style="width: 100%; height: 600px; border-radius: 12px; overflow: hidden; border: 2px solid var(--border-color);"></div>

        <div class="map-legend" style="margin-top: 16px;">
          <div class="legend-item">
            <div class="legend-color" style="background: #fbbf24;"></div>
            <span>Chest</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #22c55e;"></div>
            <span>Ammo Box</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #a855f7;"></div>
            <span>Vending</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ef4444;"></div>
            <span>Bus Path</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #06b6d4;"></div>
            <span>Safe Drop</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #f97316;"></div>
            <span>Hot Drop</span>
          </div>
        </div>
      </div>
    </div>

    <!-- NEW: PRO ANALYTICS TAB -->
    <div id="analytics" class="tab-content">
      <div class="live-tracker" id="liveTracker" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <div>
            <span class="live-badge"><span class="live-dot"></span> LIVE GAME</span>
            <span style="margin-left: 12px; color: var(--text-secondary);">Game #<span id="gameNumber">1</span></span>
          </div>
          <div style="font-family: 'Orbitron', sans-serif; font-size: 1.5rem;" id="gameTimer">00:00</div>
        </div>
        <div class="session-stats">
          <div class="session-stat">
            <div class="session-stat-value" id="liveZone">1</div>
            <div class="session-stat-label">Zone</div>
          </div>
          <div class="session-stat">
            <div class="session-stat-value" id="liveTeams">50</div>
            <div class="session-stat-label">Teams</div>
          </div>
          <div class="session-stat">
            <div class="session-stat-value" id="liveElims">0</div>
            <div class="session-stat-label">Elims</div>
          </div>
          <div class="session-stat">
            <div class="session-stat-value" id="livePlacement">-</div>
            <div class="session-stat-label">Placement</div>
          </div>
        </div>
        <div style="margin-top: 16px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>Win Probability</span>
            <span id="winProbPercent">2%</span>
          </div>
          <div class="win-meter">
            <div class="win-meter-fill" id="winProbFill" style="width: 2%;"></div>
          </div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="card-header">
            <div class="card-icon">üìä</div>
            <div class="card-title">Session Statistics</div>
          </div>
          <div class="session-stats" style="grid-template-columns: repeat(2, 1fr);">
            <div class="session-stat">
              <div class="session-stat-value" id="totalGames">0</div>
              <div class="session-stat-label">Games</div>
            </div>
            <div class="session-stat">
              <div class="session-stat-value" id="totalWins">0</div>
              <div class="session-stat-label">Wins</div>
            </div>
            <div class="session-stat">
              <div class="session-stat-value" id="avgPlacement">-</div>
              <div class="session-stat-label">Avg Place</div>
            </div>
            <div class="session-stat">
              <div class="session-stat-value" id="totalPoints">0</div>
              <div class="session-stat-label">Points</div>
            </div>
          </div>
          <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="startNewGame()">
            üéÆ Start Game Tracker
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon">üèÜ</div>
            <div class="card-title">NAC Pro Leaderboard</div>
          </div>
          <div id="proLeaderboard" style="max-height: 300px; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px;">
              <span style="color: gold;">ü•á Clix, Veno</span>
              <span style="font-family: 'Orbitron'; color: var(--accent-cyan);">1210 pts</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px;">
              <span style="color: silver;">ü•à Batman Bugha, Rapid</span>
              <span style="font-family: 'Orbitron'; color: var(--accent-cyan);">1180 pts</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px;">
              <span style="color: #cd7f32;">ü•â TaySon, Eomzo</span>
              <span style="font-family: 'Orbitron'; color: var(--accent-cyan);">1115 pts</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px;">
              <span>4. Avivv, Bugha</span>
              <span style="font-family: 'Orbitron'; color: var(--accent-cyan);">1110 pts</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-primary); border-radius: 8px; margin-bottom: 8px;">
              <span>5. Pinq, Mero</span>
              <span style="font-family: 'Orbitron'; color: var(--accent-cyan);">1090 pts</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-primary); border-radius: 8px;">
              <span>6. Ritual, Reet</span>
              <span style="font-family: 'Orbitron'; color: var(--accent-cyan);">1085 pts</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-icon">‚å®Ô∏è</div>
          <div class="card-title">Quick Commands</div>
          <span class="hotkey-hint"><kbd>1-9</kbd> Update Zone</span>
          <span class="hotkey-hint"><kbd>K</kbd> Log Kill</span>
          <span class="hotkey-hint"><kbd>G</kbd> End Game</span>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
          <div class="voice-command" onclick="updateZone()">
            <div class="voice-key">Z</div>
            <div>
              <strong>Update Zone</strong>
              <p style="font-size: 0.8rem; color: var(--text-secondary);">Track zone progression</p>
            </div>
          </div>
          <div class="voice-command" onclick="logKill()">
            <div class="voice-key">K</div>
            <div>
              <strong>Log Kill</strong>
              <p style="font-size: 0.8rem; color: var(--text-secondary);">+1 elimination</p>
            </div>
          </div>
          <div class="voice-command" onclick="toggleSurge()">
            <div class="voice-key">S</div>
            <div>
              <strong>Surge Status</strong>
              <p style="font-size: 0.8rem; color: var(--text-secondary);">Above/Below threshold</p>
            </div>
          </div>
          <div class="voice-command" onclick="endGame()">
            <div class="voice-key">G</div>
            <div>
              <strong>End Game</strong>
              <p style="font-size: 0.8rem; color: var(--text-secondary);">Record placement</p>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-icon">üìú</div>
          <div class="card-title">Game Timeline</div>
        </div>
        <div class="game-timeline" id="gameTimeline">
          <div class="timeline-line"></div>
          <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
            Start a game to see your timeline
          </div>
        </div>
      </div>

      <!-- Tournament Mode Display -->
      <div class="card" id="tourneyDisplay" style="display: none; background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), var(--bg-secondary)); border: 2px solid var(--accent-warning);">
        <!-- Tournament progress dynamically inserted here -->
      </div>

      <!-- PRO FEATURES SECTION -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon">‚ö°</div>
          <div class="card-title">Pro Features</div>
          <span class="hotkey-hint" style="margin-left: auto;">Keyboard shortcuts available</span>
        </div>
        <div class="feature-grid">
          <button class="feature-btn" id="aiCoachBtn" onclick="toggleAICoach()">ü§ñ AI Coach OFF</button>
          <button class="feature-btn" onclick="startTourneyMode()">üèÜ Tournament Mode <kbd>T</kbd></button>
          <button class="feature-btn" onclick="showMatchupAnalyzer()">üìä Pro Comparison <kbd>X</kbd></button>
          <button class="feature-btn" onclick="showPingAdvice()">üì° Ping Advisor <kbd>P</kbd></button>
          <button class="feature-btn" onclick="saveReplayMoment()">üì∏ Mark Moment <kbd>M</kbd></button>
          <button class="feature-btn" onclick="showReplayMemory()">üìº VOD Review <kbd>R</kbd></button>
        </div>
        <div style="margin-top: 16px; padding: 12px; background: var(--bg-primary); border-radius: 8px; color: var(--text-secondary); font-size: 0.85rem;">
          <strong style="color: var(--accent-primary);">üí° Pro Tip:</strong> Use keyboard shortcuts during games for faster tracking. AI Coach gives real-time tips every 15 seconds when enabled!
        </div>
      </div>

      <!-- Keyboard Shortcuts Reference -->
      <div class="card">
        <div class="card-header">
          <div class="card-icon">‚å®Ô∏è</div>
          <div class="card-title">All Keyboard Shortcuts</div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
          <div style="padding: 10px; background: var(--bg-primary); border-radius: 6px;"><kbd>1-9</kbd> Set Zone Number</div>
          <div style="padding: 10px; background: var(--bg-primary); border-radius: 6px;"><kbd>K</kbd> Log Kill (+1 Elim)</div>
          <div style="padding: 10px; background: var(--bg-primary); border-radius: 6px;"><kbd>Z</kbd> Advance Zone</div>
          <div style="padding: 10px; background: var(--bg-primary); border-radius: 6px;"><kbd>G</kbd> End Game</div>
          <div style="padding: 10px; background: var(--bg-primary); border-radius: 6px;"><kbd>S</kbd> Toggle Surge</div>
          <div style="padding: 10px; background: var(--bg-primary); border-radius: 6px;"><kbd>M</kbd> Mark VOD Moment</div>
          <div style="padding: 10px; background: var(--bg-primary); border-radius: 6px;"><kbd>C</kbd> Toggle AI Coach</div>
          <div style="padding: 10px; background: var(--bg-primary); border-radius: 6px;"><kbd>P</kbd> Ping Advisor</div>
          <div style="padding: 10px; background: var(--bg-primary); border-radius: 6px;"><kbd>R</kbd> Review Moments</div>
          <div style="padding: 10px; background: var(--bg-primary); border-radius: 6px;"><kbd>X</kbd> Pro Matchup</div>
          <div style="padding: 10px; background: var(--bg-primary); border-radius: 6px;"><kbd>T</kbd> Tournament Mode</div>
        </div>
      </div>
    </div>

    <!-- MODAL -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">√ó</button>
        <div id="modalBody"></div>
      </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="toggleQuickActions()" id="fabBtn">‚ö°</button>

    <!-- Quick Actions Menu -->
    <div class="quick-actions" id="quickActions">
      <button class="quick-action-btn" onclick="logKill()" title="Log Kill (K)">üíÄ</button>
      <button class="quick-action-btn" onclick="updateZone()" title="Update Zone (Z)">üåÄ</button>
      <button class="quick-action-btn" onclick="toggleSurge()" title="Toggle Surge (S)">‚ö°</button>
      <button class="quick-action-btn" onclick="endGame()" title="End Game (G)">üèÅ</button>
    </div>

    <!-- Sound Toggle -->
    <div class="sound-toggle" onclick="toggleSound()" id="soundToggle" title="Toggle Sounds">üîä</div>

    <!-- Confetti Canvas for wins -->
    <canvas id="confetti-canvas"></canvas>
  </div>

  <script>
    // POI Data with positions and resources
    const POI_DATA = {
      named_pois: [
        { id: "battle_boulevard", name: "Battle Boulevard", type: "named_poi", grid: "D5", loot: { chests: 28, rare_chests: 4 }, shields: { slurp_barrels: 2, slurp_trucks: 0, vending_machines: 2 }, contest_data: { popularity: "very_high" }, position: [0.35, 0.55], description: "Largest POI - LA-inspired city. High traffic, constant action.", materials: { wood: 8, brick: 7, metal: 8 } },
        { id: "sandy_strip", name: "Sandy Strip", type: "named_poi", grid: "G4", loot: { chests: 22, rare_chests: 3 }, shields: { slurp_barrels: 3, slurp_trucks: 1, vending_machines: 3 }, contest_data: { popularity: "high" }, position: [0.8, 0.45], description: "Vegas-style with The Sphere. Good loot density.", materials: { wood: 5, brick: 8, metal: 7 } },
        { id: "tiptop_terrace", name: "Tiptop Terrace", type: "named_poi", grid: "B2", loot: { chests: 18, rare_chests: 2 }, shields: { slurp_barrels: 4, slurp_trucks: 0, vending_machines: 1 }, contest_data: { popularity: "low" }, position: [0.25, 0.2], description: "Secluded forest with log cabins. Great for safe looting.", materials: { wood: 10, brick: 4, metal: 3 } },
        { id: "painted_palms", name: "Painted Palms", type: "named_poi", grid: "F6", loot: { chests: 24, rare_chests: 3 }, shields: { slurp_barrels: 2, slurp_trucks: 0, shield_kegs: 1, vending_machines: 1 }, contest_data: { popularity: "medium" }, position: [0.7, 0.7], description: "Abandoned movie set with violet foliage.", materials: { wood: 7, brick: 6, metal: 5 } },
        { id: "bumpy_bay", name: "Bumpy Bay", type: "named_poi", grid: "A4", loot: { chests: 16, rare_chests: 2 }, shields: { slurp_barrels: 3, slurp_trucks: 0, vending_machines: 1 }, contest_data: { popularity: "low" }, position: [0.1, 0.45], description: "Classic pier-themed POI with fishing spots.", materials: { wood: 9, brick: 4, metal: 4 } },
        { id: "innoloop_labs", name: "Innoloop Labs", type: "named_poi", grid: "D4", loot: { chests: 14, rare_chests: 4 }, shields: { slurp_barrels: 1, slurp_trucks: 0, vending_machines: 1 }, contest_data: { popularity: "medium" }, position: [0.5, 0.45], description: "Central tech lab with Zero Point shard.", materials: { wood: 3, brick: 5, metal: 9 } },
        { id: "fore_fields", name: "Fore Fields", type: "named_poi", grid: "H5", loot: { chests: 15, rare_chests: 2 }, shields: { slurp_barrels: 2, slurp_trucks: 0, shield_kegs: 1, vending_machines: 1 }, contest_data: { popularity: "low" }, position: [0.85, 0.55], description: "Lush golf course on the east side.", materials: { wood: 6, brick: 3, metal: 4 } },
        { id: "ripped_tides", name: "Ripped Tides", type: "named_poi", grid: "B6", loot: { chests: 20, rare_chests: 2 }, shields: { slurp_barrels: 4, slurp_trucks: 0, vending_machines: 2 }, contest_data: { popularity: "medium" }, position: [0.2, 0.7], description: "Miami-style beach with exclusive mythic shotgun.", materials: { wood: 7, brick: 5, metal: 6 } },
        { id: "sus_studios", name: "Sus Studios", type: "named_poi", grid: "C5", loot: { chests: 19, rare_chests: 2 }, shields: { slurp_barrels: 2, slurp_trucks: 0, vending_machines: 1 }, contest_data: { popularity: "medium" }, position: [0.3, 0.5], description: "Film studio with sound stages and props.", materials: { wood: 8, brick: 6, metal: 7 } },
        { id: "wonkeeland", name: "Wonkeeland / Cartmanland", type: "named_poi", grid: "F2", loot: { chests: 25, rare_chests: 3 }, shields: { slurp_barrels: 3, slurp_trucks: 0, shield_kegs: 1, vending_machines: 2 }, contest_data: { popularity: "low_medium" }, position: [0.7, 0.2], description: "Theme park with roller coaster and ferris wheel.", materials: { wood: 5, brick: 4, metal: 8 } },
        { id: "classified_canyon", name: "Classified Canyon", type: "named_poi", grid: "E6", loot: { chests: 20, rare_chests: 5 }, shields: { slurp_barrels: 2, slurp_trucks: 0, vending_machines: 1 }, contest_data: { popularity: "high" }, position: [0.55, 0.7], description: "Military base with vault. Guaranteed legendary weapons.", materials: { wood: 3, brick: 8, metal: 9 } },
        { id: "humble_hills", name: "Humble Hills", type: "named_poi", grid: "D3", loot: { chests: 17, rare_chests: 2 }, shields: { slurp_barrels: 2, slurp_trucks: 0, shield_kegs: 1, vending_machines: 1 }, contest_data: { popularity: "medium" }, position: [0.4, 0.4], description: "Hollywood Hills-inspired mansions with highground.", materials: { wood: 6, brick: 7, metal: 5 } },
        { id: "fore_shores", name: "Fore Shores", type: "named_poi", grid: "E1", loot: { chests: 14, rare_chests: 1 }, shields: { slurp_barrels: 3, slurp_trucks: 0, vending_machines: 1 }, contest_data: { popularity: "very_low" }, position: [0.55, 0.1], description: "Northern coastal haven. Very quiet.", materials: { wood: 8, brick: 3, metal: 3 } }
      ],
      landmarks: [
        { id: "toybox_docks", name: "Toybox Docks", type: "landmark", grid: "B2", loot: { chests: 12, rare_chests: 1 }, shields: { slurp_barrels: 6, slurp_trucks: 1, vending_machines: 0 }, contest_data: { popularity: "very_low" }, position: [0.2, 0.25], description: "BEST SAFE DROP - Slurp truck guarantees full shields!", materials: { wood: 10, brick: 3, metal: 4 } },
        { id: "artsy_rvs", name: "Artsy RVs", type: "landmark", grid: "E5", loot: { chests: 8, rare_chests: 0 }, shields: { slurp_barrels: 5, slurp_trucks: 0, vending_machines: 0 }, contest_data: { popularity: "very_low" }, position: [0.65, 0.55], description: "TOP COMPETITIVE PICK - Never contested, great shields.", materials: { wood: 6, brick: 2, metal: 5 } },
        { id: "peelian_swamp", name: "Peelian Swamp", type: "landmark", grid: "E6", loot: { chests: 10, rare_chests: 1 }, shields: { slurp_barrels: 4, slurp_trucks: 0, vending_machines: 0 }, contest_data: { popularity: "very_low" }, position: [0.6, 0.65], description: "Good passive drop with natural cover.", materials: { wood: 10, brick: 2, metal: 2 } },
        { id: "storm_station", name: "Storm Station", type: "landmark", grid: "D2", loot: { chests: 6, rare_chests: 0 }, shields: { slurp_barrels: 2, slurp_trucks: 0, vending_machines: 0 }, contest_data: { popularity: "very_low" }, position: [0.4, 0.25], description: "Research station with secret lore.", materials: { wood: 4, brick: 5, metal: 6 } },
        { id: "paws_inn", name: "Paws Inn / Clawsy Lodge", type: "landmark", grid: "C2", loot: { chests: 8, rare_chests: 1 }, shields: { slurp_barrels: 2, slurp_trucks: 0, vending_machines: 1 }, contest_data: { popularity: "low" }, position: [0.3, 0.2], description: "Large inn in forest. Good wood farming.", materials: { wood: 10, brick: 4, metal: 3 } }
      ],
      resources: [
        { type: "slurp_barrel", position: [0.15, 0.3], name: "Barrels near Bumpy" },
        { type: "slurp_barrel", position: [0.45, 0.5], name: "Barrels at Innoloop" },
        { type: "slurp_barrel", position: [0.62, 0.45], name: "Barrels East of Labs" },
        { type: "slurp_barrel", position: [0.75, 0.6], name: "Barrels near Painted Palms" },
        { type: "slurp_barrel", position: [0.35, 0.35], name: "Barrels at Humble Hills" },
        { type: "wood_farm", position: [0.22, 0.18], name: "Forest Wood Farm" },
        { type: "wood_farm", position: [0.28, 0.22], name: "Tiptop Trees" },
        { type: "brick_farm", position: [0.52, 0.72], name: "Canyon Brick" },
        { type: "metal_farm", position: [0.48, 0.42], name: "Innoloop Metal" },
        { type: "vehicle", position: [0.4, 0.55], name: "Car Spawn" },
        { type: "vehicle", position: [0.7, 0.35], name: "Car Spawn East" },
        { type: "balloon", position: [0.55, 0.5], name: "Balloon Station" }
      ]
    };

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
        if (tab.dataset.tab === 'map') setTimeout(drawMap, 100);
        if (tab.dataset.tab === 'rotation') setTimeout(drawRotationMap, 100);
      });
    });

    // Analyzer
    async function analyzeGame() {
      const apiKey = document.getElementById('apiKey').value.trim();
      if (!apiKey) {
        alert('Please enter your Groq API key to use the analyzer');
        return;
      }

      const situation = {
        landing_spot: document.getElementById('landingSpot').value,
        teams_contested: document.getElementById('teamsContested').value,
        our_loot: {
          weapons: document.getElementById('weapons').value,
          heals: document.getElementById('heals').value,
          shields: document.getElementById('shields').value
        },
        current_mats: {
          wood: parseInt(document.getElementById('matsWood').value) || 0,
          brick: parseInt(document.getElementById('matsBrick').value) || 0,
          metal: parseInt(document.getElementById('matsMetal').value) || 0
        },
        storm_pull: {
          direction: document.getElementById('stormDirection').value,
          distance: document.getElementById('stormDistance').value
        },
        surge_status: document.getElementById('surgeStatus').value,
        time_zone: document.getElementById('timeZone').value,
        additional_context: document.getElementById('additionalContext').value
      };

      const resultsPanel = document.getElementById('resultsPanel');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const analysisResults = document.getElementById('analysisResults');
      const analyzeBtn = document.getElementById('analyzeBtn');

      resultsPanel.style.display = 'block';
      loadingIndicator.style.display = 'flex';
      analysisResults.innerHTML = '';
      analyzeBtn.disabled = true;

      try {
        const result = await callGroqAPI(apiKey, situation);
        loadingIndicator.style.display = 'none';
        if (result.success) {
          displayResults(result.analysis);
        } else {
          analysisResults.innerHTML = `<div class="recommendation now"><strong>Error</strong><p>${result.error}</p></div>`;
        }
      } catch (error) {
        loadingIndicator.style.display = 'none';
        analysisResults.innerHTML = `<div class="recommendation now"><strong>Error</strong><p>${error.message}</p></div>`;
      }
      analyzeBtn.disabled = false;
    }

    async function callGroqAPI(apiKey, situation) {
      const systemPrompt = `You are an elite Fortnite IGL coach for NAC competitive duos (35-45ms ping). Provide tactical advice based on manual user inputs only. Return JSON with: leave_timing (recommendation + reasoning), rotate_paths (array with name, description, risk_level, time_estimate), mats_plan (current_assessment, target_before_endgame, priority, refarm_locations), fight_decision (recommendation + reasoning + conditions), surge_plan (status, action, tag_spots), contingency (if_keyed, if_zone_shifts), priority_actions (array of 3-5 top priority actions).`;

      const userPrompt = `SITUATION:
- Landing: ${situation.landing_spot || 'Not specified'}
- Teams: ${situation.teams_contested}
- Weapons: ${situation.our_loot.weapons || 'Not specified'}
- Heals: ${situation.our_loot.heals || 'Not specified'}
- Shields: ${situation.our_loot.shields}
- Mats: ${situation.current_mats.wood}/${situation.current_mats.brick}/${situation.current_mats.metal} (Total: ${situation.current_mats.wood + situation.current_mats.brick + situation.current_mats.metal})
- Storm Pull: ${situation.storm_pull.direction}, Distance: ${situation.storm_pull.distance}
- Surge: ${situation.surge_status}
- Zone/Time: ${situation.time_zone || 'Not specified'}
- Context: ${situation.additional_context || 'None'}

Provide tactical JSON response with specific actionable advice.`;

      const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'llama-3.1-70b-versatile',
          messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: userPrompt }],
          temperature: 0.3,
          max_tokens: 2000,
          response_format: { type: 'json_object' }
        })
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.error?.message || `API Error: ${response.status}`);
      }

      const data = await response.json();
      try {
        return { success: true, analysis: JSON.parse(data.choices[0]?.message?.content) };
      } catch {
        return { success: false, error: 'Failed to parse response' };
      }
    }

    function displayResults(analysis) {
      const container = document.getElementById('analysisResults');
      let html = '';

      if (analysis.priority_actions?.length) {
        html += `<div class="result-section"><h3>üéØ Priority Actions</h3><ol class="priority-list">${analysis.priority_actions.map(a => `<li>${a}</li>`).join('')}</ol></div>`;
      }

      if (analysis.leave_timing) {
        const cls = analysis.leave_timing.recommendation === 'now' ? 'now' : analysis.leave_timing.recommendation?.includes('40') ? 'safe' : 'warning';
        html += `<div class="result-section"><h3>‚è±Ô∏è Leave Timing</h3><div class="recommendation ${cls}"><strong>${(analysis.leave_timing.recommendation || '').toUpperCase()}</strong><p>${analysis.leave_timing.reasoning || ''}</p></div></div>`;
      }

      if (analysis.rotate_paths?.length) {
        html += `<div class="result-section"><h3>üõ§Ô∏è Rotation Paths</h3>${analysis.rotate_paths.map(p => `<div class="path-card"><h4>${p.name}</h4><span class="risk-badge ${p.risk_level}">${p.risk_level} risk</span> <span style="color:var(--text-secondary);margin-left:10px;">${p.time_estimate || ''}</span><p style="margin-top:10px;">${p.description}</p></div>`).join('')}</div>`;
      }

      if (analysis.fight_decision) {
        const cls = analysis.fight_decision.recommendation === 'fight' ? 'now' : analysis.fight_decision.recommendation === 'refuse' ? 'safe' : 'warning';
        html += `<div class="result-section"><h3>‚öîÔ∏è Fight Decision</h3><div class="recommendation ${cls}"><strong>${(analysis.fight_decision.recommendation || '').toUpperCase()}</strong><p>${analysis.fight_decision.reasoning || ''}</p>${analysis.fight_decision.conditions?.length ? `<ul style="margin-top:10px;padding-left:20px;">${analysis.fight_decision.conditions.map(c => `<li>${c}</li>`).join('')}</ul>` : ''}</div></div>`;
      }

      if (analysis.mats_plan) {
        html += `<div class="result-section"><h3>ü™µ Materials Plan</h3><div class="recommendation"><strong>Status: ${(analysis.mats_plan.current_assessment || '').toUpperCase()}</strong><p>Target: ${analysis.mats_plan.target_before_endgame || 'N/A'}</p><p>Priority: ${analysis.mats_plan.priority || 'N/A'}</p><p>Refarm at: ${analysis.mats_plan.refarm_locations?.join(', ') || 'N/A'}</p></div></div>`;
      }

      if (analysis.surge_plan) {
        html += `<div class="result-section"><h3>‚ö° Surge Plan</h3><div class="recommendation ${analysis.surge_plan.action === 'emergency' ? 'now' : 'safe'}"><strong>Action: ${(analysis.surge_plan.action || '').toUpperCase()}</strong>${analysis.surge_plan.tag_spots?.length ? `<p>Tag spots: ${analysis.surge_plan.tag_spots.join(', ')}</p>` : ''}</div></div>`;
      }

      if (analysis.contingency) {
        html += `<div class="result-section"><h3>üõ°Ô∏è Contingency</h3><div class="recommendation"><strong>If Keyed:</strong><p>${analysis.contingency.if_keyed || 'N/A'}</p>${analysis.contingency.if_zone_shifts ? `<p style="margin-top:10px;"><strong>If Zone Shifts:</strong> ${analysis.contingency.if_zone_shifts}</p>` : ''}</div></div>`;
      }

      container.innerHTML = html;
    }

    // Rotation Planner
    let playerPosition = null;
    let zonePosition = null;

    function planRotation() {
      const currentPos = document.getElementById('currentPosition').value.toUpperCase();
      const zoneCenter = document.getElementById('zoneCenter').value.toUpperCase();
      const currentZone = document.getElementById('currentZone').value;
      const teamsAlive = document.getElementById('teamsAlive').value;

      if (!currentPos || !zoneCenter) {
        alert('Please enter your current position and zone center');
        return;
      }

      // Calculate route and predictions
      const route = calculateOptimalRoute(currentPos, zoneCenter, currentZone);
      const predictions = predictTeamPositions(zoneCenter, teamsAlive, currentZone);
      const resources = findResourcesAlongRoute(currentPos, zoneCenter);

      // Display results
      document.getElementById('rotationResults').style.display = 'block';

      // Team predictions
      document.getElementById('teamPredictions').innerHTML = predictions.map(p => `
        <div class="prediction-item">
          <span>${p.location}</span>
          <span class="prediction-chance ${p.chance >= 70 ? 'high' : p.chance >= 40 ? 'medium' : 'low'}">${p.chance}%</span>
        </div>
      `).join('');

      // Optimal route
      document.getElementById('optimalRoute').innerHTML = route.map((step, i) => `
        <div class="route-waypoint ${step.type}">
          <div class="route-waypoint-icon">${step.icon}</div>
          <div class="route-waypoint-info">
            <h4>${i + 1}. ${step.name}</h4>
            <p>${step.description}</p>
          </div>
        </div>
      `).join('');

      // Resources
      document.getElementById('refarmSpots').innerHTML = `
        <h4 style="margin-bottom: 12px; color: var(--accent-success);">üõ¢Ô∏è Refarm Opportunities</h4>
        ${resources.refarm.map(r => `
          <div class="route-waypoint resource">
            <div class="route-waypoint-icon">${r.icon}</div>
            <div class="route-waypoint-info">
              <h4>${r.name} <span class="refarm-badge">${r.type}</span></h4>
              <p>${r.description}</p>
            </div>
          </div>
        `).join('')}
      `;

      document.getElementById('dangerZones').innerHTML = `
        <h4 style="margin-bottom: 12px; color: var(--accent-danger);">‚ö†Ô∏è Danger Zones to Avoid</h4>
        ${resources.dangers.map(d => `
          <div class="route-waypoint danger">
            <div class="route-waypoint-icon">${d.icon}</div>
            <div class="route-waypoint-info">
              <h4>${d.name} <span class="danger-badge">${d.reason}</span></h4>
              <p>${d.description}</p>
            </div>
          </div>
        `).join('')}
      `;

      // Update map
      drawRotationMap(currentPos, zoneCenter, route);
    }

    function calculateOptimalRoute(from, to, zone) {
      // Basic pathfinding - in a real implementation this would be more sophisticated
      const routes = [
        { icon: 'üìç', name: `Start: ${from}`, description: 'Begin rotation immediately', type: '' },
        { icon: 'üèÉ', name: 'Use natural cover', description: 'Hug terrain edges, avoid open areas', type: '' },
        { icon: 'üõ¢Ô∏è', name: 'Hit barrels on path', description: 'Top off shields if needed (5s max)', type: 'resource' },
        { icon: 'üè†', name: 'Check buildings', description: 'Quick wood refarm if below 300', type: 'resource' },
        { icon: 'üëÄ', name: 'Scan before commit', description: 'AR scan zone edge before entering', type: '' },
        { icon: 'üéØ', name: `Arrive: ${to}`, description: 'Claim strong layer position', type: '' }
      ];
      return routes;
    }

    function predictTeamPositions(zoneCenter, teamsAlive, currentZone) {
      // Based on zone pull and teams alive, predict likely positions
      const predictions = [];
      const allPOIs = [...POI_DATA.named_pois, ...POI_DATA.landmarks];

      // Find POIs near zone
      allPOIs.forEach(poi => {
        if (poi.contest_data?.popularity === 'high' || poi.contest_data?.popularity === 'very_high') {
          predictions.push({
            location: poi.name,
            chance: Math.floor(Math.random() * 30) + 50 // 50-80% for hot drops
          });
        } else if (poi.contest_data?.popularity === 'medium') {
          predictions.push({
            location: poi.name,
            chance: Math.floor(Math.random() * 25) + 25 // 25-50%
          });
        }
      });

      // Add edge holding positions
      predictions.push({ location: 'Zone edge (North)', chance: 65 });
      predictions.push({ location: 'Zone edge (South)', chance: 70 });
      predictions.push({ location: 'Highground center', chance: 55 });

      return predictions.sort((a, b) => b.chance - a.chance).slice(0, 6);
    }

    function findResourcesAlongRoute(from, to) {
      return {
        refarm: [
          { icon: 'üõ¢Ô∏è', name: 'Slurp Barrels', type: 'Shields', description: '3 barrels - quick full shield' },
          { icon: 'ü™µ', name: 'Wood Farm Spot', type: 'Mats', description: 'Dense trees - 200 wood in 10s' },
          { icon: 'üß±', name: 'Brick Pile', type: 'Mats', description: 'Rock cluster - 150 brick' },
          { icon: 'üöó', name: 'Vehicle Spawn', type: 'Mobility', description: 'Car available for fast rotate' }
        ],
        dangers: [
          { icon: 'üî•', name: 'Battle Boulevard edge', reason: 'High Traffic', description: 'Teams rotating from BB - go wide' },
          { icon: 'üëÅÔ∏è', name: 'Hill sightline', reason: 'Exposed', description: 'Visible from multiple angles - smoke or build' },
          { icon: '‚ö°', name: 'Open field', reason: 'No Cover', description: 'Sprint through, dont stop' }
        ]
      };
    }

    // Rotation Map with click support
    function drawRotationMap(currentPos, zoneCenter, route) {
      const canvas = document.getElementById('rotationMapCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;

      // Draw fortnite.gg map background if loaded
      if (mapImageLoaded && mapImage) {
        ctx.drawImage(mapImage, 0, 0, canvas.width, canvas.height);
        // Add slight dark overlay for better marker visibility
        ctx.fillStyle = 'rgba(0, 0, 0, 0.25)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      } else {
        // Fallback background
        const bg = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width/1.5);
        bg.addColorStop(0, '#1a1a25');
        bg.addColorStop(1, '#0d0d15');
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      // Grid overlay
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 8; i++) {
        ctx.beginPath();
        ctx.moveTo((canvas.width / 8) * i, 0);
        ctx.lineTo((canvas.width / 8) * i, canvas.height);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, (canvas.height / 8) * i);
        ctx.lineTo(canvas.width, (canvas.height / 8) * i);
        ctx.stroke();
      }

      // Grid labels
      ctx.fillStyle = 'rgba(255,255,255,0.5)';
      ctx.font = 'bold 12px Inter';
      const letters = 'ABCDEFGH';
      for (let i = 0; i < 8; i++) {
        ctx.fillText(letters[i], (canvas.width / 8) * i + canvas.width / 16 - 4, 15);
        ctx.fillText(i + 1, 5, (canvas.height / 8) * i + canvas.height / 16 + 4);
      }

      // Draw POIs
      [...POI_DATA.named_pois, ...POI_DATA.landmarks].forEach(poi => {
        if (!poi.position) return;
        const [x, y] = poi.position;
        const px = x * canvas.width;
        const py = y * canvas.height;

        ctx.beginPath();
        ctx.arc(px, py, 8, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(99, 102, 241, 0.6)';
        ctx.fill();
      });

      // Draw resources
      POI_DATA.resources.forEach(res => {
        const [x, y] = res.position;
        const px = x * canvas.width;
        const py = y * canvas.height;

        ctx.beginPath();
        ctx.arc(px, py, 6, 0, Math.PI * 2);
        ctx.fillStyle = res.type === 'slurp_barrel' ? '#06b6d4' :
                        res.type === 'wood_farm' ? '#a0522d' :
                        res.type === 'brick_farm' ? '#cd5c5c' :
                        res.type === 'metal_farm' ? '#708090' :
                        res.type === 'vehicle' ? '#f59e0b' : '#6366f1';
        ctx.fill();
      });

      // Draw zone circle if set
      if (zoneCenter) {
        const zonePos = gridToPosition(zoneCenter);
        if (zonePos) {
          ctx.beginPath();
          ctx.arc(zonePos.x * canvas.width, zonePos.y * canvas.height, canvas.width * 0.25, 0, Math.PI * 2);
          ctx.strokeStyle = 'rgba(6, 182, 212, 0.6)';
          ctx.lineWidth = 3;
          ctx.setLineDash([10, 5]);
          ctx.stroke();
          ctx.setLineDash([]);

          // Zone center marker
          ctx.beginPath();
          ctx.arc(zonePos.x * canvas.width, zonePos.y * canvas.height, 10, 0, Math.PI * 2);
          ctx.fillStyle = '#06b6d4';
          ctx.fill();
        }
      }

      // Draw player position
      if (currentPos) {
        const pos = gridToPosition(currentPos);
        if (pos) {
          ctx.beginPath();
          ctx.arc(pos.x * canvas.width, pos.y * canvas.height, 12, 0, Math.PI * 2);
          ctx.fillStyle = '#10b981';
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 3;
          ctx.stroke();

          // Draw route line
          if (zoneCenter) {
            const zonePos = gridToPosition(zoneCenter);
            if (zonePos) {
              ctx.beginPath();
              ctx.moveTo(pos.x * canvas.width, pos.y * canvas.height);
              ctx.lineTo(zonePos.x * canvas.width, zonePos.y * canvas.height);
              ctx.strokeStyle = '#6366f1';
              ctx.lineWidth = 3;
              ctx.setLineDash([8, 4]);
              ctx.stroke();
              ctx.setLineDash([]);
            }
          }
        }
      }
    }

    function gridToPosition(grid) {
      const match = grid.match(/([A-H])([1-8])/i);
      if (!match) return null;
      const col = match[1].toUpperCase().charCodeAt(0) - 65;
      const row = parseInt(match[2]) - 1;
      return { x: (col + 0.5) / 8, y: (row + 0.5) / 8 };
    }

    // Click handler for rotation map
    document.getElementById('rotationMapCanvas')?.addEventListener('click', function(e) {
      const rect = this.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top) / rect.height;

      const col = String.fromCharCode(65 + Math.floor(x * 8));
      const row = Math.floor(y * 8) + 1;
      const grid = col + row;

      document.getElementById('currentPosition').value = grid;
      drawRotationMap(grid, document.getElementById('zoneCenter').value);
    });

    // Drop Explorer
    function filterDrops() {
      const style = document.getElementById('styleFilter').value;
      const type = document.getElementById('typeFilter').value;
      const sort = document.getElementById('sortFilter').value;

      let allPOIs = [...POI_DATA.named_pois, ...POI_DATA.landmarks];
      if (type !== 'all') allPOIs = allPOIs.filter(p => p.type === type);

      allPOIs = allPOIs.map(poi => {
        const chests = poi.loot?.chests || 0;
        const rareChests = poi.loot?.rare_chests || 0;
        const shields = (poi.shields?.slurp_barrels || 0) + (poi.shields?.slurp_trucks || 0) * 3 + (poi.shields?.vending_machines || 0);
        const contestMap = { very_low: 10, low: 8, low_medium: 6, medium: 5, high: 2, very_high: 0 };
        const contestScore = contestMap[poi.contest_data?.popularity] || 5;

        let score = style === 'balanced' ? (chests * 0.3) + (rareChests * 0.5) + (shields * 0.2) + (contestScore * 0.5)
                  : style === 'super_safe' ? (chests * 0.15) + (shields * 0.3) + (contestScore * 0.8)
                  : (chests * 0.4) + (rareChests * 0.6) + (shields * 0.15) + (contestScore * 0.2);

        return { ...poi, score: Math.round(score * 100) / 100, shieldScore: shields };
      });

      if (sort === 'score') allPOIs.sort((a, b) => b.score - a.score);
      else if (sort === 'chests') allPOIs.sort((a, b) => b.loot.chests - a.loot.chests);
      else if (sort === 'shields') allPOIs.sort((a, b) => b.shieldScore - a.shieldScore);
      else if (sort === 'contest_low') {
        const order = { very_low: 1, low: 2, low_medium: 3, medium: 4, high: 5, very_high: 6 };
        allPOIs.sort((a, b) => order[a.contest_data?.popularity] - order[b.contest_data?.popularity]);
      }

      const tbody = document.getElementById('poiTableBody');
      tbody.innerHTML = allPOIs.map((poi, i) => {
        const scoreClass = poi.score >= 8 ? 'high' : poi.score >= 5 ? 'medium' : 'low';
        return `<tr>
          <td><strong>#${i + 1}</strong></td>
          <td><span class="poi-name">${poi.name}</span></td>
          <td><span class="poi-type">${poi.type === 'named_poi' ? 'POI' : 'Landmark'}</span></td>
          <td><span class="score-badge ${scoreClass}">${poi.score}</span></td>
          <td>${poi.loot?.chests || 0}</td>
          <td>${poi.shieldScore}</td>
          <td>${(poi.contest_data?.popularity || '').replace('_', ' ')}</td>
          <td><button class="view-btn" onclick="showDropCard('${poi.id}')">View</button></td>
        </tr>`;
      }).join('');
    }

    function showDropCard(poiId) {
      const poi = [...POI_DATA.named_pois, ...POI_DATA.landmarks].find(p => p.id === poiId);
      if (!poi) return;

      const shields = (poi.shields?.slurp_barrels || 0) + (poi.shields?.slurp_trucks || 0) * 3 + (poi.shields?.vending_machines || 0);

      document.getElementById('modalBody').innerHTML = `
        <h2 class="modal-title">${poi.name}</h2>
        <p style="color:var(--text-secondary);margin-bottom:24px;">${poi.description || ''}</p>
        <div class="modal-grid">
          <div class="modal-stat"><div class="modal-stat-label">Chests</div><div class="modal-stat-value">${poi.loot?.chests || 0}</div></div>
          <div class="modal-stat"><div class="modal-stat-label">Rare Chests</div><div class="modal-stat-value">${poi.loot?.rare_chests || 0}</div></div>
          <div class="modal-stat"><div class="modal-stat-label">Shield Score</div><div class="modal-stat-value">${shields}</div></div>
          <div class="modal-stat"><div class="modal-stat-label">Contest</div><div class="modal-stat-value">${(poi.contest_data?.popularity || '').replace('_', ' ')}</div></div>
        </div>
        <div style="margin-top:20px;">
          <h4 style="margin-bottom:12px;">Shield Sources</h4>
          <p>Slurp Barrels: ${poi.shields?.slurp_barrels || 0}</p>
          <p>Slurp Trucks: ${poi.shields?.slurp_trucks || 0}</p>
          <p>Vending Machines: ${poi.shields?.vending_machines || 0}</p>
        </div>
        <div style="margin-top:16px;">
          <h4 style="margin-bottom:12px;">Materials</h4>
          <p>ü™µ Wood: ${poi.materials?.wood || 0}/10</p>
          <p>üß± Brick: ${poi.materials?.brick || 0}/10</p>
          <p>‚öôÔ∏è Metal: ${poi.materials?.metal || 0}/10</p>
        </div>
        <div style="margin-top:24px;">
          <a href="https://fortnite.gg/map" target="_blank" class="btn btn-secondary" style="text-decoration:none;">View on Fortnite.gg ‚Üí</a>
        </div>
      `;
      document.getElementById('modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
    }

    // ========== LEAFLET MAP SYSTEM ==========
    let leafletMap = null;
    let mapLayerGroups = {};
    let busPathLine = null;
    let busStartMarker = null;
    let busEndMarker = null;
    let clickMode = 'start'; // 'start' or 'end'

    const mapLayerState = {
      pois: true, chests: true, ammo: true, vending: false, mending: false,
      vehicles: false, ziplines: false, campfires: false, reboot: false,
      launchpads: false, portapotty: false, busPath: true
    };

    // Fortnite map bounds (using CRS.Simple for game coordinates)
    const MAP_BOUNDS = [[0, 0], [256, 256]];

    // Convert grid (A1-H8) to map coordinates
    function gridToMapCoords(grid) {
      const match = grid.match(/([A-H])([1-8])/i);
      if (!match) return null;
      const col = match[1].toUpperCase().charCodeAt(0) - 65;
      const row = parseInt(match[2]) - 1;
      // Leaflet Y is inverted
      return [(7 - row) * 32 + 16, col * 32 + 16];
    }

    // Convert map coordinates to grid
    function mapCoordsToGrid(lat, lng) {
      const col = String.fromCharCode(65 + Math.floor(lng / 32));
      const row = 8 - Math.floor(lat / 32);
      return col + row;
    }

    // Initialize Leaflet map with fortnite.gg tiles
    function initLeafletMap() {
      if (leafletMap) return;

      // Create map with simple CRS for game coordinates
      leafletMap = L.map('leafletMap', {
        crs: L.CRS.Simple,
        minZoom: 0,
        maxZoom: 5,
        zoomSnap: 0.5,
        zoomDelta: 0.5,
        attributionControl: false
      });

      // Set initial view
      leafletMap.setView([128, 128], 1);

      // Add fortnite.gg tile layer
      L.tileLayer('https://fortnite.gg/maps/39.02/{z}/{x}/{y}.jpg', {
        minZoom: 0,
        maxZoom: 5,
        tileSize: 256,
        noWrap: true,
        bounds: MAP_BOUNDS
      }).addTo(leafletMap);

      // Create layer groups
      mapLayerGroups = {
        pois: L.layerGroup().addTo(leafletMap),
        chests: L.layerGroup().addTo(leafletMap),
        ammo: L.layerGroup().addTo(leafletMap),
        vending: L.layerGroup(),
        mending: L.layerGroup(),
        vehicles: L.layerGroup(),
        ziplines: L.layerGroup(),
        campfires: L.layerGroup(),
        reboot: L.layerGroup(),
        launchpads: L.layerGroup(),
        portapotty: L.layerGroup(),
        busPath: L.layerGroup().addTo(leafletMap)
      };

      // Add POI markers
      addPOIMarkers();
      addChestMarkers();
      addAmmoMarkers();
      addVendingMarkers();
      addVehicleMarkers();
      addRebootMarkers();

      // Click handler for bus path
      leafletMap.on('click', handleMapClick);

      // Add grid overlay
      addGridOverlay();
    }

    function handleMapClick(e) {
      const grid = mapCoordsToGrid(e.latlng.lat, e.latlng.lng);

      if (clickMode === 'start') {
        document.getElementById('busStart').value = grid;
        clickMode = 'end';
      } else {
        document.getElementById('busEnd').value = grid;
        clickMode = 'start';
      }
      updateBusPath();
    }

    function addGridOverlay() {
      // Add grid lines
      for (let i = 0; i <= 8; i++) {
        // Vertical lines
        L.polyline([[0, i * 32], [256, i * 32]], {
          color: 'rgba(255,255,255,0.2)',
          weight: 1
        }).addTo(leafletMap);
        // Horizontal lines
        L.polyline([[i * 32, 0], [i * 32, 256]], {
          color: 'rgba(255,255,255,0.2)',
          weight: 1
        }).addTo(leafletMap);
      }

      // Add grid labels
      const letters = 'ABCDEFGH';
      for (let i = 0; i < 8; i++) {
        // Column labels (A-H) at top
        L.marker([252, i * 32 + 16], {
          icon: L.divIcon({
            className: 'grid-label',
            html: `<div style="color: rgba(255,255,255,0.6); font-weight: bold; font-size: 14px;">${letters[i]}</div>`,
            iconSize: [20, 20]
          })
        }).addTo(leafletMap);
        // Row labels (1-8) on left
        L.marker([(7 - i) * 32 + 16, 6], {
          icon: L.divIcon({
            className: 'grid-label',
            html: `<div style="color: rgba(255,255,255,0.6); font-weight: bold; font-size: 14px;">${i + 1}</div>`,
            iconSize: [20, 20]
          })
        }).addTo(leafletMap);
      }
    }

    function addPOIMarkers() {
      const allPOIs = [...POI_DATA.named_pois, ...POI_DATA.landmarks];
      allPOIs.forEach(poi => {
        if (!poi.position) return;
        const [x, y] = poi.position;
        // Convert 0-1 position to 0-256
        const lat = (1 - y) * 256;
        const lng = x * 256;

        const contest = poi.contest_data?.popularity;
        let color = '#f59e0b';
        if (contest === 'very_low' || contest === 'low') color = '#10b981';
        if (contest === 'high' || contest === 'very_high') color = '#ef4444';

        const marker = L.marker([lat, lng], {
          icon: L.divIcon({
            className: 'poi-marker',
            html: `
              <div style="text-align: center;">
                <div style="width: ${poi.type === 'named_poi' ? 28 : 20}px; height: ${poi.type === 'named_poi' ? 28 : 20}px; background: ${color}; border: 3px solid white; border-radius: 50%; margin: 0 auto; box-shadow: 0 2px 8px rgba(0,0,0,0.5);"></div>
                <div class="poi-label" style="margin-top: 2px;">${poi.name.split(' ')[0]}</div>
              </div>
            `,
            iconSize: [80, 50],
            iconAnchor: [40, 20]
          })
        });
        marker.bindPopup(`
          <div style="min-width: 200px;">
            <strong style="font-size: 1.1rem;">${poi.name}</strong>
            <hr style="margin: 8px 0; border-color: #333;">
            <div>üì¶ Chests: ${poi.loot?.chests || 0}</div>
            <div>‚≠ê Rare Chests: ${poi.loot?.rare_chests || 0}</div>
            <div>üõ¢Ô∏è Slurp: ${poi.shields?.slurp_barrels || 0}</div>
            <div>üìä Contest: ${poi.contest_data?.popularity?.replace('_', ' ') || 'Unknown'}</div>
          </div>
        `);
        marker.addTo(mapLayerGroups.pois);
      });
    }

    // Chest locations (approximate based on POI positions)
    const CHEST_LOCATIONS = [
      // Battle Boulevard area
      {lat: 115, lng: 90}, {lat: 112, lng: 92}, {lat: 118, lng: 88}, {lat: 110, lng: 95},
      {lat: 120, lng: 85}, {lat: 108, lng: 90}, {lat: 115, lng: 98}, {lat: 122, lng: 92},
      // Sandy Strip
      {lat: 140, lng: 205}, {lat: 138, lng: 200}, {lat: 142, lng: 210}, {lat: 135, lng: 198},
      // Tiptop Terrace
      {lat: 205, lng: 65}, {lat: 200, lng: 60}, {lat: 210, lng: 70}, {lat: 195, lng: 55},
      // Innoloop Labs
      {lat: 140, lng: 128}, {lat: 142, lng: 125}, {lat: 138, lng: 132}, {lat: 145, lng: 130},
      // Classified Canyon
      {lat: 78, lng: 140}, {lat: 75, lng: 145}, {lat: 82, lng: 138}, {lat: 70, lng: 142},
      // Ripped Tides
      {lat: 78, lng: 52}, {lat: 75, lng: 48}, {lat: 82, lng: 55}, {lat: 72, lng: 50},
      // Toybox Docks
      {lat: 192, lng: 52}, {lat: 188, lng: 48}, {lat: 195, lng: 58}, {lat: 185, lng: 55},
      // Painted Palms
      {lat: 78, lng: 180}, {lat: 75, lng: 175}, {lat: 82, lng: 185}, {lat: 72, lng: 178},
      // Wonkeeland
      {lat: 205, lng: 180}, {lat: 200, lng: 175}, {lat: 210, lng: 185},
    ];

    function addChestMarkers() {
      CHEST_LOCATIONS.forEach(loc => {
        L.marker([loc.lat, loc.lng], {
          icon: L.divIcon({
            className: 'chest-marker-icon',
            html: '<div class="chest-marker">üì¶</div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          })
        }).addTo(mapLayerGroups.chests);
      });
    }

    const AMMO_LOCATIONS = [
      {lat: 115, lng: 88}, {lat: 118, lng: 94}, {lat: 140, lng: 202}, {lat: 205, lng: 62},
      {lat: 140, lng: 130}, {lat: 78, lng: 143}, {lat: 78, lng: 50}, {lat: 190, lng: 55},
      {lat: 75, lng: 180}, {lat: 202, lng: 178}, {lat: 160, lng: 100}, {lat: 100, lng: 160},
    ];

    function addAmmoMarkers() {
      AMMO_LOCATIONS.forEach(loc => {
        L.marker([loc.lat, loc.lng], {
          icon: L.divIcon({
            className: 'ammo-marker-icon',
            html: '<div class="ammo-marker">üî´</div>',
            iconSize: [18, 18],
            iconAnchor: [9, 9]
          })
        }).addTo(mapLayerGroups.ammo);
      });
    }

    const VENDING_LOCATIONS = [
      {lat: 115, lng: 92}, {lat: 140, lng: 205}, {lat: 140, lng: 128}, {lat: 78, lng: 140}, {lat: 100, lng: 100},
    ];

    function addVendingMarkers() {
      VENDING_LOCATIONS.forEach(loc => {
        L.marker([loc.lat, loc.lng], {
          icon: L.divIcon({
            html: '<div style="background: #a855f7; width: 24px; height: 24px; border: 2px solid white; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 14px;">üèß</div>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
          })
        }).addTo(mapLayerGroups.vending);
      });
    }

    const VEHICLE_LOCATIONS = [
      {lat: 120, lng: 95}, {lat: 145, lng: 200}, {lat: 200, lng: 70}, {lat: 145, lng: 125}, {lat: 80, lng: 145},
      {lat: 80, lng: 55}, {lat: 185, lng: 60}, {lat: 80, lng: 175}, {lat: 200, lng: 175}, {lat: 128, lng: 128},
    ];

    function addVehicleMarkers() {
      VEHICLE_LOCATIONS.forEach(loc => {
        L.marker([loc.lat, loc.lng], {
          icon: L.divIcon({
            html: '<div style="background: #f59e0b; width: 26px; height: 26px; border: 2px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px;">üöó</div>',
            iconSize: [26, 26],
            iconAnchor: [13, 13]
          })
        }).addTo(mapLayerGroups.vehicles);
      });
    }

    const REBOOT_LOCATIONS = [
      {lat: 112, lng: 95}, {lat: 138, lng: 208}, {lat: 208, lng: 65}, {lat: 138, lng: 125}, {lat: 75, lng: 142},
      {lat: 75, lng: 52}, {lat: 192, lng: 55}, {lat: 75, lng: 178}, {lat: 75, lng: 72},
    ];

    function addRebootMarkers() {
      REBOOT_LOCATIONS.forEach(loc => {
        L.marker([loc.lat, loc.lng], {
          icon: L.divIcon({
            html: '<div style="background: #22c55e; width: 28px; height: 28px; border: 3px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white;">R</div>',
            iconSize: [28, 28],
            iconAnchor: [14, 14]
          })
        }).addTo(mapLayerGroups.reboot);
      });
    }

    function toggleMapLayer(layer) {
      mapLayerState[layer] = !mapLayerState[layer];
      document.getElementById('toggle-' + layer)?.classList.toggle('active');

      if (mapLayerGroups[layer]) {
        if (mapLayerState[layer]) {
          leafletMap.addLayer(mapLayerGroups[layer]);
        } else {
          leafletMap.removeLayer(mapLayerGroups[layer]);
        }
      }
    }

    // Bus Path Functions
    function updateBusPath() {
      const startGrid = document.getElementById('busStart').value.trim().toUpperCase();
      const endGrid = document.getElementById('busEnd').value.trim().toUpperCase();

      // Clear existing
      if (busPathLine) mapLayerGroups.busPath.removeLayer(busPathLine);
      if (busStartMarker) mapLayerGroups.busPath.removeLayer(busStartMarker);
      if (busEndMarker) mapLayerGroups.busPath.removeLayer(busEndMarker);

      const startCoords = gridToMapCoords(startGrid);
      const endCoords = gridToMapCoords(endGrid);

      if (startCoords) {
        busStartMarker = L.marker(startCoords, {
          icon: L.divIcon({
            html: '<div style="background: #ef4444; width: 32px; height: 32px; border: 3px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 0 15px #ef4444;">üöå</div>',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
          })
        }).addTo(mapLayerGroups.busPath);
      }

      if (endCoords) {
        busEndMarker = L.marker(endCoords, {
          icon: L.divIcon({
            html: '<div style="background: #ef4444; width: 24px; height: 24px; border: 3px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">üèÅ</div>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
          })
        }).addTo(mapLayerGroups.busPath);
      }

      if (startCoords && endCoords) {
        busPathLine = L.polyline([startCoords, endCoords], {
          color: '#ef4444',
          weight: 5,
          opacity: 0.9,
          dashArray: '15, 10'
        }).addTo(mapLayerGroups.busPath);
      }
    }

    function clearBusPath() {
      document.getElementById('busStart').value = '';
      document.getElementById('busEnd').value = '';
      document.getElementById('busAnalysis').style.display = 'none';
      if (busPathLine) mapLayerGroups.busPath.removeLayer(busPathLine);
      if (busStartMarker) mapLayerGroups.busPath.removeLayer(busStartMarker);
      if (busEndMarker) mapLayerGroups.busPath.removeLayer(busEndMarker);
      busPathLine = null;
      busStartMarker = null;
      busEndMarker = null;
      clickMode = 'start';
    }

    function analyzeBusPath() {
      const startGrid = document.getElementById('busStart').value.trim().toUpperCase();
      const endGrid = document.getElementById('busEnd').value.trim().toUpperCase();

      if (!startGrid || !endGrid) {
        alert('Please set both bus start and end points!');
        return;
      }

      const startCoords = gridToMapCoords(startGrid);
      const endCoords = gridToMapCoords(endGrid);

      if (!startCoords || !endCoords) {
        alert('Invalid grid coordinates!');
        return;
      }

      // Calculate distance from each POI to bus path
      const allPOIs = [...POI_DATA.named_pois, ...POI_DATA.landmarks];
      const poisWithDistance = allPOIs.map(poi => {
        if (!poi.position) return null;
        const [x, y] = poi.position;
        const poiLat = (1 - y) * 256;
        const poiLng = x * 256;

        // Distance from point to line segment
        const dist = pointToLineDistance(poiLat, poiLng, startCoords[0], startCoords[1], endCoords[0], endCoords[1]);

        return { ...poi, busDistance: dist };
      }).filter(p => p && p.busDistance < 80); // Within reasonable drop range

      poisWithDistance.sort((a, b) => a.busDistance - b.busDistance);

      const recommendations = document.getElementById('busDropRecommendations');
      recommendations.innerHTML = poisWithDistance.slice(0, 6).map(poi => {
        const contest = poi.contest_data?.popularity;
        let className = '';
        if (contest === 'high' || contest === 'very_high') className = 'hot';
        else if (contest === 'medium' || contest === 'low_medium') className = 'contested';

        return `
          <div class="bus-drop-item ${className}">
            <div>
              <strong>${poi.name}</strong>
              <div style="font-size: 0.8rem; color: var(--text-secondary);">
                ${poi.loot?.chests || 0} chests ‚Ä¢ ${poi.contest_data?.popularity?.replace('_', ' ') || 'Unknown'} contest
              </div>
            </div>
            <div class="drop-distance">${Math.round(poi.busDistance)}m</div>
          </div>
        `;
      }).join('');

      document.getElementById('busAnalysis').style.display = 'block';
    }

    // Helper: Distance from point to line segment
    function pointToLineDistance(px, py, x1, y1, x2, y2) {
      const A = px - x1;
      const B = py - y1;
      const C = x2 - x1;
      const D = y2 - y1;

      const dot = A * C + B * D;
      const lenSq = C * C + D * D;
      let param = -1;
      if (lenSq !== 0) param = dot / lenSq;

      let xx, yy;
      if (param < 0) { xx = x1; yy = y1; }
      else if (param > 1) { xx = x2; yy = y2; }
      else { xx = x1 + param * C; yy = y1 + param * D; }

      const dx = px - xx;
      const dy = py - yy;
      return Math.sqrt(dx * dx + dy * dy);
    }

    // Keep old functions for rotation map canvas
    const mapLayers = { pois: true, routes: false, zones: false, resources: false };
    let mapImage = null;
    let mapImageLoaded = false;

    function loadMapImage() {
      mapImage = new Image();
      mapImage.crossOrigin = 'anonymous';
      mapImage.src = 'https://fortnite.gg/maps/39.02/0/0/0.jpg';
      mapImage.onload = () => {
        mapImageLoaded = true;
        drawRotationMap();
      };
      mapImage.onerror = () => {
        mapImageLoaded = false;
      };
    }

    function toggleLayer(layer) {
      mapLayers[layer] = !mapLayers[layer];
      document.getElementById('btn-' + layer)?.classList.toggle('active');
    }

    function drawMap() {
      const canvas = document.getElementById('mapCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;

      // Draw fortnite.gg map background if loaded
      if (mapImageLoaded && mapImage) {
        ctx.drawImage(mapImage, 0, 0, canvas.width, canvas.height);
        // Add slight dark overlay for better marker visibility
        ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      } else {
        // Fallback gradient background
        const bg = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width/1.5);
        bg.addColorStop(0, '#1a1a25');
        bg.addColorStop(1, '#0d0d15');
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      // Grid overlay
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 8; i++) {
        ctx.beginPath();
        ctx.moveTo((canvas.width / 8) * i, 0);
        ctx.lineTo((canvas.width / 8) * i, canvas.height);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, (canvas.height / 8) * i);
        ctx.lineTo(canvas.width, (canvas.height / 8) * i);
        ctx.stroke();
      }

      // Grid labels
      ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
      ctx.font = 'bold 12px Inter, sans-serif';
      const letters = 'ABCDEFGH';
      for (let i = 0; i < 8; i++) {
        ctx.fillText(letters[i], (canvas.width / 8) * i + canvas.width / 16 - 4, 15);
        ctx.fillText(i + 1, 5, (canvas.height / 8) * i + canvas.height / 16 + 4);
      }

      if (mapLayers.zones) {
        ctx.beginPath();
        ctx.arc(canvas.width * 0.5, canvas.height * 0.5, canvas.width * 0.35, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(6, 182, 212, 0.5)';
        ctx.lineWidth = 3;
        ctx.setLineDash([10, 5]);
        ctx.stroke();
        ctx.setLineDash([]);
      }

      if (mapLayers.routes) {
        ctx.beginPath();
        ctx.strokeStyle = '#6366f1';
        ctx.lineWidth = 4;
        ctx.setLineDash([12, 6]);
        ctx.moveTo(0.2 * canvas.width, 0.25 * canvas.height);
        ctx.lineTo(0.5 * canvas.width, 0.45 * canvas.height);
        ctx.lineTo(0.55 * canvas.width, 0.7 * canvas.height);
        ctx.stroke();
        ctx.setLineDash([]);
      }

      if (mapLayers.resources) {
        POI_DATA.resources.forEach(res => {
          const [x, y] = res.position;
          const px = x * canvas.width;
          const py = y * canvas.height;

          ctx.beginPath();
          ctx.arc(px, py, 8, 0, Math.PI * 2);
          ctx.fillStyle = res.type === 'slurp_barrel' ? '#06b6d4' :
                          res.type === 'wood_farm' ? '#a0522d' :
                          res.type === 'brick_farm' ? '#cd5c5c' :
                          res.type === 'metal_farm' ? '#708090' :
                          res.type === 'vehicle' ? '#f59e0b' : '#8b5cf6';
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 1;
          ctx.stroke();
        });
      }

      if (mapLayers.pois) {
        [...POI_DATA.named_pois, ...POI_DATA.landmarks].forEach(poi => {
          if (!poi.position) return;
          const [x, y] = poi.position;
          const px = x * canvas.width;
          const py = y * canvas.height;

          const contest = poi.contest_data?.popularity;
          let color = '#f59e0b';
          if (contest === 'very_low' || contest === 'low') color = '#10b981';
          if (contest === 'high' || contest === 'very_high') color = '#ef4444';

          ctx.beginPath();
          ctx.arc(px, py, 20, 0, Math.PI * 2);
          ctx.fillStyle = color + '33';
          ctx.fill();

          ctx.beginPath();
          ctx.arc(px, py, poi.type === 'named_poi' ? 14 : 10, 0, Math.PI * 2);
          ctx.fillStyle = color;
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.stroke();

          ctx.fillStyle = '#fff';
          ctx.font = 'bold 11px Inter, sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(poi.name.split(' ')[0], px, py + 28);
        });
      }
    }

    // Modal close
    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target.id === 'modal') closeModal();
    });

    // ========== NEW FEATURES ==========

    // Map Layer System (fortnite.gg style)
    const mapLayerState = {
      pois: true, chests: false, slurp: false, vending: false,
      vehicles: false, ziplines: false, campfires: false, reboot: false,
      heatmap: false, rotations: false, zones: false
    };

    // Additional map data for layers
    const MAP_MARKERS = {
      chests: [
        [0.35, 0.55], [0.36, 0.54], [0.34, 0.56], [0.37, 0.55], // Battle Boulevard
        [0.8, 0.45], [0.79, 0.44], [0.81, 0.46], // Sandy Strip
        [0.25, 0.2], [0.24, 0.21], [0.26, 0.19], // Tiptop
        [0.5, 0.45], [0.51, 0.44], [0.49, 0.46], // Innoloop
        [0.55, 0.7], [0.56, 0.69], [0.54, 0.71], // Canyon
      ],
      slurp: [
        [0.15, 0.3], [0.22, 0.25], [0.45, 0.5], [0.62, 0.45],
        [0.75, 0.6], [0.35, 0.35], [0.2, 0.7], [0.65, 0.55]
      ],
      vending: [
        [0.35, 0.52], [0.78, 0.43], [0.48, 0.47], [0.53, 0.72], [0.28, 0.5]
      ],
      vehicles: [
        [0.4, 0.55], [0.7, 0.35], [0.3, 0.3], [0.6, 0.5], [0.25, 0.65]
      ],
      ziplines: [
        [[0.3, 0.4], [0.4, 0.5]], [[0.5, 0.3], [0.6, 0.4]], [[0.7, 0.5], [0.8, 0.6]]
      ],
      campfires: [
        [0.25, 0.22], [0.38, 0.38], [0.55, 0.55], [0.72, 0.68], [0.18, 0.72]
      ],
      reboot: [
        [0.35, 0.58], [0.78, 0.48], [0.22, 0.22], [0.5, 0.48], [0.55, 0.73], [0.7, 0.72]
      ]
    };

    // Pro rotation data (analyzed from FNCS gameplay - NAC Duos 2026)
    const PRO_ROTATIONS = [
      { from: [0.2, 0.25], to: [0.4, 0.45], name: 'Toybox ‚Üí Center', usage: 85, pros: ['Clix/Veno', 'Mero/Pinq'] },
      { from: [0.35, 0.55], to: [0.5, 0.45], name: 'BB ‚Üí Innoloop', usage: 72, pros: ['Bugha/Rapid'] },
      { from: [0.8, 0.45], to: [0.55, 0.5], name: 'Sandy ‚Üí Mid', usage: 68, pros: ['TaySon/Eomzo'] },
      { from: [0.55, 0.7], to: [0.5, 0.5], name: 'Canyon ‚Üí Center', usage: 78, pros: ['Reet/Ritual'] },
      { from: [0.2, 0.7], to: [0.35, 0.55], name: 'Ripped ‚Üí BB', usage: 45, pros: ['Avivv/Bugha'] },
      { from: [0.7, 0.2], to: [0.55, 0.4], name: 'Wonkee ‚Üí Mid', usage: 52, pros: [] },
      { from: [0.15, 0.4], to: [0.35, 0.45], name: 'Artsy ‚Üí Center', usage: 62, pros: [] },
      { from: [0.65, 0.75], to: [0.55, 0.6], name: 'Palms ‚Üí Mid', usage: 48, pros: [] }
    ];

    // Detailed pro drop spots data
    const PRO_DROP_DATA = {
      'Clix/Veno': { drop: 'Toybox Docks', style: 'aggressive', avgPlacement: 8.2, winRate: 12 },
      'Bugha/Rapid': { drop: 'Battle Boulevard', style: 'smart aggro', avgPlacement: 6.5, winRate: 18 },
      'TaySon/Eomzo': { drop: 'Sandy Strip', style: 'calculated', avgPlacement: 7.8, winRate: 14 },
      'Reet/Ritual': { drop: 'Classified Canyon', style: 'edge rotate', avgPlacement: 9.1, winRate: 10 },
      'Mero/Pinq': { drop: 'Tiptop Terrace', style: 'uncontested', avgPlacement: 5.2, winRate: 22 },
      'Avivv/Bugha': { drop: 'Ripped Tides', style: 'zone control', avgPlacement: 7.4, winRate: 15 }
    };

    // Zone pull statistics (based on pro analysis)
    const ZONE_PULLS = [
      { center: [0.35, 0.65], weight: 35, name: 'SW Pull' },
      { center: [0.5, 0.5], weight: 25, name: 'Center' },
      { center: [0.65, 0.3], weight: 20, name: 'NE Pull' },
      { center: [0.6, 0.65], weight: 15, name: 'SE Pull' },
      { center: [0.3, 0.25], weight: 5, name: 'NW Pull' }
    ];

    function toggleMapLayer(layer) {
      mapLayerState[layer] = !mapLayerState[layer];
      document.getElementById('toggle-' + layer)?.classList.toggle('active');
      drawMap();
    }

    // Enhanced drawMap with all layers
    const originalDrawMap = drawMap;
    drawMap = function() {
      const canvas = document.getElementById('mapCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;

      // Draw fortnite.gg map background
      if (mapImageLoaded && mapImage) {
        ctx.drawImage(mapImage, 0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      } else {
        const bg = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width/1.5);
        bg.addColorStop(0, '#1a1a25');
        bg.addColorStop(1, '#0d0d15');
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      // Grid
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 8; i++) {
        ctx.beginPath();
        ctx.moveTo((canvas.width / 8) * i, 0);
        ctx.lineTo((canvas.width / 8) * i, canvas.height);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, (canvas.height / 8) * i);
        ctx.lineTo(canvas.width, (canvas.height / 8) * i);
        ctx.stroke();
      }

      // Pro Heatmap
      if (mapLayerState.heatmap) {
        const hotspots = [
          { pos: [0.35, 0.55], intensity: 0.9 }, // BB
          { pos: [0.55, 0.7], intensity: 0.8 }, // Canyon
          { pos: [0.8, 0.45], intensity: 0.75 }, // Sandy
          { pos: [0.5, 0.45], intensity: 0.7 }, // Innoloop
          { pos: [0.5, 0.5], intensity: 0.85 }, // Center
        ];
        hotspots.forEach(h => {
          const grad = ctx.createRadialGradient(
            h.pos[0] * canvas.width, h.pos[1] * canvas.height, 0,
            h.pos[0] * canvas.width, h.pos[1] * canvas.height, canvas.width * 0.15
          );
          grad.addColorStop(0, `rgba(255, 0, 0, ${h.intensity * 0.5})`);
          grad.addColorStop(0.5, `rgba(255, 165, 0, ${h.intensity * 0.3})`);
          grad.addColorStop(1, 'rgba(255, 255, 0, 0)');
          ctx.fillStyle = grad;
          ctx.fillRect(0, 0, canvas.width, canvas.height);
        });
      }

      // Zone pulls
      if (mapLayerState.zones) {
        ZONE_PULLS.forEach(zone => {
          ctx.beginPath();
          ctx.arc(zone.center[0] * canvas.width, zone.center[1] * canvas.height, canvas.width * 0.12, 0, Math.PI * 2);
          ctx.strokeStyle = `rgba(6, 182, 212, ${zone.weight / 50})`;
          ctx.lineWidth = 3;
          ctx.setLineDash([8, 4]);
          ctx.stroke();
          ctx.setLineDash([]);
          ctx.fillStyle = 'rgba(6, 182, 212, 0.8)';
          ctx.font = 'bold 10px Inter';
          ctx.textAlign = 'center';
          ctx.fillText(`${zone.weight}%`, zone.center[0] * canvas.width, zone.center[1] * canvas.height + 4);
        });
      }

      // Pro rotations
      if (mapLayerState.rotations) {
        PRO_ROTATIONS.forEach(rot => {
          ctx.beginPath();
          ctx.moveTo(rot.from[0] * canvas.width, rot.from[1] * canvas.height);
          ctx.lineTo(rot.to[0] * canvas.width, rot.to[1] * canvas.height);
          ctx.strokeStyle = `rgba(99, 102, 241, ${rot.usage / 100})`;
          ctx.lineWidth = 3 + (rot.usage / 30);
          ctx.stroke();
          // Arrow
          const angle = Math.atan2(rot.to[1] - rot.from[1], rot.to[0] - rot.from[0]);
          const midX = (rot.from[0] + rot.to[0]) / 2 * canvas.width;
          const midY = (rot.from[1] + rot.to[1]) / 2 * canvas.height;
          ctx.beginPath();
          ctx.moveTo(midX, midY);
          ctx.lineTo(midX - 10 * Math.cos(angle - 0.5), midY - 10 * Math.sin(angle - 0.5));
          ctx.lineTo(midX - 10 * Math.cos(angle + 0.5), midY - 10 * Math.sin(angle + 0.5));
          ctx.closePath();
          ctx.fillStyle = '#6366f1';
          ctx.fill();
        });
      }

      // Chests
      if (mapLayerState.chests) {
        MAP_MARKERS.chests.forEach(pos => {
          ctx.fillStyle = '#fbbf24';
          ctx.fillRect(pos[0] * canvas.width - 5, pos[1] * canvas.height - 5, 10, 10);
          ctx.strokeStyle = '#000';
          ctx.lineWidth = 1;
          ctx.strokeRect(pos[0] * canvas.width - 5, pos[1] * canvas.height - 5, 10, 10);
        });
      }

      // Slurp barrels
      if (mapLayerState.slurp) {
        MAP_MARKERS.slurp.forEach(pos => {
          ctx.beginPath();
          ctx.arc(pos[0] * canvas.width, pos[1] * canvas.height, 8, 0, Math.PI * 2);
          ctx.fillStyle = '#06b6d4';
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.stroke();
        });
      }

      // Vending machines
      if (mapLayerState.vending) {
        MAP_MARKERS.vending.forEach(pos => {
          ctx.fillStyle = '#a855f7';
          ctx.fillRect(pos[0] * canvas.width - 6, pos[1] * canvas.height - 8, 12, 16);
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 1;
          ctx.strokeRect(pos[0] * canvas.width - 6, pos[1] * canvas.height - 8, 12, 16);
        });
      }

      // Vehicles
      if (mapLayerState.vehicles) {
        MAP_MARKERS.vehicles.forEach(pos => {
          ctx.beginPath();
          ctx.arc(pos[0] * canvas.width, pos[1] * canvas.height, 8, 0, Math.PI * 2);
          ctx.fillStyle = '#f59e0b';
          ctx.fill();
          ctx.fillStyle = '#000';
          ctx.font = 'bold 10px Inter';
          ctx.textAlign = 'center';
          ctx.fillText('üöó', pos[0] * canvas.width, pos[1] * canvas.height + 4);
        });
      }

      // Ziplines
      if (mapLayerState.ziplines) {
        MAP_MARKERS.ziplines.forEach(line => {
          ctx.beginPath();
          ctx.moveTo(line[0][0] * canvas.width, line[0][1] * canvas.height);
          ctx.lineTo(line[1][0] * canvas.width, line[1][1] * canvas.height);
          ctx.strokeStyle = '#10b981';
          ctx.lineWidth = 3;
          ctx.stroke();
        });
      }

      // Campfires
      if (mapLayerState.campfires) {
        MAP_MARKERS.campfires.forEach(pos => {
          ctx.fillStyle = '#f97316';
          ctx.font = '14px sans-serif';
          ctx.fillText('üî•', pos[0] * canvas.width - 7, pos[1] * canvas.height + 5);
        });
      }

      // Reboot vans
      if (mapLayerState.reboot) {
        MAP_MARKERS.reboot.forEach(pos => {
          ctx.beginPath();
          ctx.arc(pos[0] * canvas.width, pos[1] * canvas.height, 10, 0, Math.PI * 2);
          ctx.fillStyle = '#22c55e';
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.stroke();
          ctx.fillStyle = '#fff';
          ctx.font = 'bold 12px Inter';
          ctx.textAlign = 'center';
          ctx.fillText('R', pos[0] * canvas.width, pos[1] * canvas.height + 4);
        });
      }

      // POIs
      if (mapLayerState.pois) {
        [...POI_DATA.named_pois, ...POI_DATA.landmarks].forEach(poi => {
          if (!poi.position) return;
          const [x, y] = poi.position;
          const px = x * canvas.width;
          const py = y * canvas.height;
          const contest = poi.contest_data?.popularity;
          let color = '#f59e0b';
          if (contest === 'very_low' || contest === 'low') color = '#10b981';
          if (contest === 'high' || contest === 'very_high') color = '#ef4444';
          ctx.beginPath();
          ctx.arc(px, py, poi.type === 'named_poi' ? 14 : 10, 0, Math.PI * 2);
          ctx.fillStyle = color;
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.stroke();
          ctx.fillStyle = '#fff';
          ctx.font = 'bold 10px Inter';
          ctx.textAlign = 'center';
          ctx.fillText(poi.name.split(' ')[0], px, py + 24);
        });
      }
    };

    // ========== GAME TRACKER ==========
    let gameState = {
      active: false,
      startTime: null,
      zone: 1,
      teams: 50,
      elims: 0,
      placement: null,
      timeline: [],
      timerInterval: null
    };

    let sessionStats = {
      games: 0,
      wins: 0,
      placements: [],
      totalPoints: 0
    };

    let soundEnabled = true;

    function playSound(type) {
      if (!soundEnabled) return;
      const sounds = {
        kill: [800, 0.1],
        zone: [400, 0.15],
        win: [600, 0.3],
        start: [500, 0.1]
      };
      const [freq, dur] = sounds[type] || [440, 0.1];
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + dur);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + dur);
      } catch(e) {}
    }

    function toggleSound() {
      soundEnabled = !soundEnabled;
      document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîá';
    }

    function toggleQuickActions() {
      document.getElementById('quickActions').classList.toggle('active');
      document.getElementById('fabBtn').textContent =
        document.getElementById('quickActions').classList.contains('active') ? '‚úï' : '‚ö°';
    }

    function startNewGame() {
      gameState = {
        active: true,
        startTime: Date.now(),
        zone: 1,
        teams: 50,
        elims: 0,
        placement: null,
        timeline: [{ time: 0, type: 'start', text: 'Game Started' }]
      };
      sessionStats.games++;
      document.getElementById('liveTracker').style.display = 'block';
      document.getElementById('gameNumber').textContent = sessionStats.games;
      updateLiveDisplay();
      playSound('start');

      // Start timer
      if (gameState.timerInterval) clearInterval(gameState.timerInterval);
      gameState.timerInterval = setInterval(updateGameTimer, 1000);

      addTimelineEvent('start', 'Game started');
    }

    function updateGameTimer() {
      if (!gameState.active) return;
      const elapsed = Math.floor((Date.now() - gameState.startTime) / 1000);
      const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
      const secs = (elapsed % 60).toString().padStart(2, '0');
      document.getElementById('gameTimer').textContent = `${mins}:${secs}`;
    }

    function updateLiveDisplay() {
      document.getElementById('liveZone').textContent = gameState.zone;
      document.getElementById('liveTeams').textContent = gameState.teams;
      document.getElementById('liveElims').textContent = gameState.elims;
      document.getElementById('livePlacement').textContent = gameState.placement || '-';
      document.getElementById('totalGames').textContent = sessionStats.games;
      document.getElementById('totalWins').textContent = sessionStats.wins;
      document.getElementById('totalPoints').textContent = sessionStats.totalPoints;
      if (sessionStats.placements.length > 0) {
        const avg = sessionStats.placements.reduce((a,b) => a+b, 0) / sessionStats.placements.length;
        document.getElementById('avgPlacement').textContent = avg.toFixed(1);
      }
      // Win probability calculation
      const prob = calculateWinProbability();
      document.getElementById('winProbPercent').textContent = prob + '%';
      document.getElementById('winProbFill').style.width = prob + '%';
    }

    function calculateWinProbability() {
      if (!gameState.active) return 0;
      const baseProb = (1 / gameState.teams) * 100;
      const elimBonus = gameState.elims * 2;
      const zoneBonus = gameState.zone * 3;
      return Math.min(99, Math.round(baseProb + elimBonus + zoneBonus));
    }

    function updateZone() {
      if (!gameState.active) return;
      gameState.zone = Math.min(9, gameState.zone + 1);
      gameState.teams = Math.max(1, Math.floor(gameState.teams * 0.7));
      playSound('zone');
      addTimelineEvent('zone', `Zone ${gameState.zone} - ${gameState.teams} teams`);
      updateLiveDisplay();
    }

    function logKill() {
      if (!gameState.active) return;
      gameState.elims++;
      gameState.teams = Math.max(1, gameState.teams - 1);
      playSound('kill');
      addTimelineEvent('kill', `Elimination #${gameState.elims}`);
      updateLiveDisplay();
    }

    function toggleSurge() {
      // Quick toggle implementation
      const surgeEl = document.getElementById('surgeStatus');
      if (surgeEl) {
        const opts = surgeEl.options;
        surgeEl.selectedIndex = (surgeEl.selectedIndex + 1) % opts.length;
      }
    }

    function endGame() {
      if (!gameState.active) return;
      const placement = parseInt(prompt('Final placement? (1-50)', gameState.teams));
      if (isNaN(placement) || placement < 1 || placement > 50) return;

      gameState.placement = placement;
      gameState.active = false;
      clearInterval(gameState.timerInterval);

      // Calculate points (FNCS scoring)
      const placementPoints = {
        1: 25, 2: 20, 3: 16, 4: 14, 5: 12, 6: 10, 7: 9, 8: 8, 9: 7, 10: 6,
        11: 5, 12: 5, 13: 4, 14: 4, 15: 3, 16: 2, 17: 2, 18: 2, 19: 1, 20: 1
      };
      const placePoints = placementPoints[placement] || 0;
      const elimPoints = gameState.elims * 2;
      const totalGamePoints = placePoints + elimPoints;

      sessionStats.placements.push(placement);
      sessionStats.totalPoints += totalGamePoints;
      if (placement === 1) {
        sessionStats.wins++;
        playSound('win');
        launchConfetti();
      }

      addTimelineEvent('end', `#${placement} - ${totalGamePoints} points (${placePoints} + ${elimPoints})`);
      updateLiveDisplay();
      document.getElementById('livePlacement').textContent = `#${placement}`;

      // Show game summary
      alert(`üèÜ Game Over!\n\nPlacement: #${placement}\nEliminations: ${gameState.elims}\nPoints: ${totalGamePoints}\n\nSession Total: ${sessionStats.totalPoints} points`);
    }

    function addTimelineEvent(type, text) {
      const timeline = document.getElementById('gameTimeline');
      const elapsed = gameState.startTime ? Math.floor((Date.now() - gameState.startTime) / 1000) : 0;
      const mins = Math.floor(elapsed / 60);
      const secs = elapsed % 60;
      const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;

      const event = document.createElement('div');
      event.className = 'timeline-event';
      event.innerHTML = `
        <div class="timeline-dot ${type}"></div>
        <div>
          <strong>${timeStr}</strong>
          <p style="color: var(--text-secondary); margin: 0;">${text}</p>
        </div>
      `;

      // Remove placeholder if exists
      const placeholder = timeline.querySelector('div[style*="text-align: center"]');
      if (placeholder) placeholder.remove();

      timeline.appendChild(event);
      timeline.scrollTop = timeline.scrollHeight;
    }

    // Confetti effect for wins
    function launchConfetti() {
      const canvas = document.getElementById('confetti-canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const particles = [];
      const colors = ['#6366f1', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444'];

      for (let i = 0; i < 150; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height - canvas.height,
          vx: (Math.random() - 0.5) * 10,
          vy: Math.random() * 3 + 2,
          color: colors[Math.floor(Math.random() * colors.length)],
          size: Math.random() * 8 + 4,
          rotation: Math.random() * 360
        });
      }

      let frame = 0;
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.1;
          p.rotation += 5;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rotation * Math.PI / 180);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
          ctx.restore();
        });
        frame++;
        if (frame < 180) requestAnimationFrame(animate);
        else ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
      animate();
    }

    // ========== MIND-BLOWING SURPRISE FEATURES ==========

    // 1. AI COACH - Real-time voice coaching suggestions
    let aiCoachEnabled = false;
    const AI_COACH_TIPS = {
      zone1: ["üéØ Farm up! You need 1500 mats minimum for endgame", "Hit slurp barrels on rotate", "Identify teams around you NOW"],
      zone2: ["üîç Start watching for surge - you need 50+ damage", "Don't fight unless tagged first", "Note deadside for later"],
      zone3: ["‚ö†Ô∏è Surge check! Get tags NOW if below threshold", "Pre-aim rotate paths", "Don't commit to full fights"],
      zone4: ["üåÄ HALF-HALF! Take early layer or you'll get gatekept", "Build height if uncontested", "Look for free eliminations"],
      zone5: ["üèÉ GO GO GO! No more passive play", "Use terrain, don't over-build", "Target weak teams first"],
      zone6: ["üî• CLUTCH TIME! Every piece matters", "Don't panic tarp - read the lobby", "One mistake = death"],
      zone7: ["üíÄ HEAL-OFF PREP! Position near storm edge", "Count remaining teams", "Save medkits for final circle"],
      lowSurge: ["‚ö° SURGE EMERGENCY! Shoot ANYTHING that moves", "Don't be picky - any tags count", "Consider storm push if desperate"],
      lowMats: ["ü™µ MAT CRISIS! Stop building, start ratting", "Use natural cover only", "One wall per spray max"],
      goodPosition: ["‚úÖ GOOD SPOT! Don't overpeek", "Let teams come to you", "Tag rotating teams for free damage"]
    };

    function toggleAICoach() {
      aiCoachEnabled = !aiCoachEnabled;
      const btn = document.getElementById('aiCoachBtn');
      if (btn) {
        btn.classList.toggle('active');
        btn.innerHTML = aiCoachEnabled ? 'ü§ñ AI Coach ON' : 'ü§ñ AI Coach OFF';
      }
      if (aiCoachEnabled) {
        startAICoaching();
        showNotification('ü§ñ AI Coach activated! Real-time tips enabled.', 'success');
      }
    }

    function startAICoaching() {
      if (!aiCoachEnabled) return;
      setInterval(() => {
        if (!gameState.active || !aiCoachEnabled) return;
        const tip = getContextualTip();
        if (tip) showCoachTip(tip);
      }, 15000); // Every 15 seconds
    }

    function getContextualTip() {
      const zone = gameState.zone;
      const tips = AI_COACH_TIPS['zone' + zone] || AI_COACH_TIPS.zone1;
      return tips[Math.floor(Math.random() * tips.length)];
    }

    function showCoachTip(tip) {
      const notification = document.createElement('div');
      notification.className = 'coach-tip-popup';
      notification.innerHTML = `<div class="coach-avatar">üß†</div><div class="coach-message">${tip}</div>`;
      document.body.appendChild(notification);
      setTimeout(() => notification.classList.add('show'), 100);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }

    // 2. CLUTCH MOMENT DETECTOR - Detects high-pressure situations
    function detectClutchMoment() {
      if (!gameState.active) return null;
      const teams = gameState.teams;
      const zone = gameState.zone;
      const elims = gameState.elims;

      if (teams <= 5 && zone >= 6) return { type: 'FINAL_FIGHT', intensity: 100, message: 'üî• CLUTCH UP! Top 5 in endgame!' };
      if (teams <= 10 && zone >= 5) return { type: 'ENDGAME', intensity: 80, message: '‚ö° Endgame mode - every play matters!' };
      if (teams <= 15 && elims >= 3) return { type: 'ON_FIRE', intensity: 70, message: 'üéØ You\'re cracked! Keep the momentum!' };
      if (zone >= 7) return { type: 'HEAL_OFF', intensity: 90, message: 'üíä HEAL OFF PREP - Position NOW!' };
      return null;
    }

    // 3. MATCHUP ANALYZER - Compare your stats vs pro players
    function showMatchupAnalyzer() {
      const modal = document.getElementById('modal');
      const modalBody = document.getElementById('modalBody');

      const yourStats = {
        avgPlacement: sessionStats.placements.length > 0
          ? (sessionStats.placements.reduce((a,b) => a+b, 0) / sessionStats.placements.length).toFixed(1)
          : 'N/A',
        winRate: sessionStats.games > 0 ? ((sessionStats.wins / sessionStats.games) * 100).toFixed(1) : 0,
        pointsPerGame: sessionStats.games > 0 ? (sessionStats.totalPoints / sessionStats.games).toFixed(1) : 0
      };

      modalBody.innerHTML = `
        <h2 class="modal-title">üìä Pro Matchup Analyzer</h2>
        <p style="color:var(--text-secondary);margin-bottom:24px;">See how you compare to NAC pros this session</p>

        <div style="display: grid; gap: 16px;">
          <div style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); padding: 20px; border-radius: 12px;">
            <h3 style="margin-bottom: 12px;">üìà Your Session Stats</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center;">
              <div><div style="font-size: 2rem; font-family: Orbitron;">${yourStats.avgPlacement}</div><div style="opacity: 0.8;">Avg Place</div></div>
              <div><div style="font-size: 2rem; font-family: Orbitron;">${yourStats.winRate}%</div><div style="opacity: 0.8;">Win Rate</div></div>
              <div><div style="font-size: 2rem; font-family: Orbitron;">${yourStats.pointsPerGame}</div><div style="opacity: 0.8;">Pts/Game</div></div>
            </div>
          </div>

          <h3 style="margin-top: 16px;">üèÜ Compare to Pros</h3>
          ${Object.entries(PRO_DROP_DATA).map(([name, data]) => {
            const comparison = parseFloat(yourStats.avgPlacement) <= data.avgPlacement ? '‚úÖ Better' : 'üìà Work on it';
            return `
              <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>${name}</strong>
                  <div style="color: var(--text-secondary); font-size: 0.85rem;">${data.drop} ‚Ä¢ ${data.style}</div>
                </div>
                <div style="text-align: right;">
                  <div>Avg #${data.avgPlacement} ‚Ä¢ ${data.winRate}% WR</div>
                  <div style="color: ${parseFloat(yourStats.avgPlacement) <= data.avgPlacement ? 'var(--accent-success)' : 'var(--accent-warning)'}; font-size: 0.85rem;">
                    ${yourStats.avgPlacement !== 'N/A' ? comparison : 'Play games to compare'}
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>

        <button class="btn btn-secondary" style="width: 100%; margin-top: 20px;" onclick="closeModal()">Close</button>
      `;
      modal.classList.add('active');
    }

    // 4. STREAK TRACKER - Track hot/cold streaks
    let streakData = { current: 0, type: null, best: 0 };

    function updateStreak(placement) {
      const isGood = placement <= 10;
      if (isGood) {
        if (streakData.type === 'hot' || streakData.type === null) {
          streakData.current++;
          streakData.type = 'hot';
          if (streakData.current > streakData.best) streakData.best = streakData.current;
          if (streakData.current >= 3) {
            showNotification(`üî• HOT STREAK! ${streakData.current} top 10s in a row!`, 'success');
          }
        } else {
          streakData.current = 1;
          streakData.type = 'hot';
        }
      } else {
        if (streakData.type === 'cold' || streakData.type === null) {
          streakData.current++;
          streakData.type = 'cold';
        } else {
          streakData.current = 1;
          streakData.type = 'cold';
        }
      }
    }

    // 5. TOURNAMENT SIMULATOR - Practice under pressure
    let tourneyMode = { active: false, gamesRemaining: 0, totalPoints: 0, targetPoints: 0 };

    function startTourneyMode() {
      const games = parseInt(prompt('How many games in this tournament? (6-12)', '6'));
      if (isNaN(games) || games < 1) return;

      const target = parseInt(prompt('Target points to qualify?', '100'));

      tourneyMode = {
        active: true,
        gamesRemaining: games,
        totalPoints: 0,
        targetPoints: target || 100
      };

      showNotification(`üèÜ TOURNAMENT MODE! ${games} games, ${target} pts to qualify. LET'S GO!`, 'success');
      updateTourneyDisplay();
    }

    function updateTourneyDisplay() {
      const display = document.getElementById('tourneyDisplay');
      if (!display) return;

      if (tourneyMode.active) {
        const ptsNeeded = tourneyMode.targetPoints - tourneyMode.totalPoints;
        const ptsPerGame = tourneyMode.gamesRemaining > 0 ? (ptsNeeded / tourneyMode.gamesRemaining).toFixed(1) : 0;
        display.style.display = 'block';
        display.innerHTML = `
          <div class="tourney-status">
            <span>üèÜ TOURNAMENT MODE</span>
            <span>${tourneyMode.gamesRemaining} games left</span>
          </div>
          <div class="tourney-progress">
            <div class="tourney-bar" style="width: ${Math.min(100, (tourneyMode.totalPoints / tourneyMode.targetPoints) * 100)}%"></div>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-secondary);">
            <span>${tourneyMode.totalPoints} / ${tourneyMode.targetPoints} pts</span>
            <span>Need ~${ptsPerGame} pts/game</span>
          </div>
        `;
      } else {
        display.style.display = 'none';
      }
    }

    // 6. REPLAY MEMORY - Remember key moments
    let replayMemory = [];

    function saveReplayMoment() {
      if (!gameState.active) return;
      const moment = {
        timestamp: Date.now(),
        game: sessionStats.games,
        zone: gameState.zone,
        teams: gameState.teams,
        elims: gameState.elims,
        note: prompt('Quick note about this moment:') || 'Key moment'
      };
      replayMemory.push(moment);
      showNotification('üì∏ Moment saved! Review in VOD analysis later.', 'info');
    }

    function showReplayMemory() {
      const modal = document.getElementById('modal');
      const modalBody = document.getElementById('modalBody');

      modalBody.innerHTML = `
        <h2 class="modal-title">üìº Replay Memory</h2>
        <p style="color:var(--text-secondary);margin-bottom:24px;">Key moments from your session for VOD review</p>

        ${replayMemory.length === 0 ? '<p style="text-align: center; padding: 40px;">No moments saved yet. Press <kbd>M</kbd> during games to save!</p>' :
          replayMemory.map((m, i) => `
            <div style="background: var(--bg-primary); padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid var(--accent-primary);">
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <strong>Game ${m.game} - Zone ${m.zone}</strong>
                <span style="color: var(--text-secondary);">${m.teams} teams ‚Ä¢ ${m.elims} elims</span>
              </div>
              <p style="margin: 0;">${m.note}</p>
            </div>
          `).join('')
        }

        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="replayMemory = []; showReplayMemory();">Clear All</button>
          <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">Close</button>
        </div>
      `;
      modal.classList.add('active');
    }

    // 7. SMART NOTIFICATIONS
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `smart-notification ${type}`;
      notification.innerHTML = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.classList.add('show'), 100);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    // 8. PING COMPENSATION CALCULATOR
    function showPingAdvice() {
      const ping = parseInt(prompt('What is your current ping? (ms)', '40'));
      if (isNaN(ping)) return;

      let advice = [];
      if (ping <= 20) {
        advice = ['‚úÖ Low ping - you can piece control!', 'üéØ Edit plays are viable', '‚ö° 50/50s favor you'];
      } else if (ping <= 45) {
        advice = ['‚ö†Ô∏è Mid ping - be selective with fights', 'üéØ Prefire every edit by 50ms', 'üî´ Favor AR over edits', 'üèÉ Take layer EARLY'];
      } else {
        advice = ['‚ùå High ping - avoid 50/50s completely', 'üî´ AR beam is your best friend', 'üè† Hold boxes, never push', '‚è∞ React to edits, don\'t initiate'];
      }

      const modal = document.getElementById('modal');
      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = `
        <h2 class="modal-title">üì° Ping Compensation Guide</h2>
        <p style="color:var(--text-secondary);margin-bottom:24px;">Optimized strategy for ${ping}ms ping</p>

        <div style="background: linear-gradient(135deg, ${ping <= 20 ? 'var(--accent-success)' : ping <= 45 ? 'var(--accent-warning)' : 'var(--accent-danger)'}, transparent); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <h3 style="font-size: 3rem; margin-bottom: 8px;">${ping}ms</h3>
          <p>${ping <= 20 ? 'Optimal for competitive' : ping <= 45 ? 'Playable with adjustments' : 'Challenging - adapt playstyle'}</p>
        </div>

        <h3 style="margin-bottom: 12px;">üìã Your Ping-Specific Strategy:</h3>
        ${advice.map(a => `<div style="background: var(--bg-primary); padding: 12px 16px; border-radius: 8px; margin-bottom: 8px;">${a}</div>`).join('')}

        <button class="btn btn-secondary" style="width: 100%; margin-top: 20px;" onclick="closeModal()">Got it!</button>
      `;
      modal.classList.add('active');
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

      if (e.key >= '1' && e.key <= '9' && gameState.active) {
        gameState.zone = parseInt(e.key);
        updateLiveDisplay();
        playSound('zone');
        // Check for clutch moments
        const clutch = detectClutchMoment();
        if (clutch) showNotification(clutch.message, clutch.intensity > 80 ? 'success' : 'info');
      }
      if (e.key.toLowerCase() === 'k') logKill();
      if (e.key.toLowerCase() === 'g') endGame();
      if (e.key.toLowerCase() === 'z') updateZone();
      if (e.key.toLowerCase() === 's') toggleSurge();
      if (e.key.toLowerCase() === 'm') saveReplayMoment(); // M = Mark moment for VOD review
      if (e.key.toLowerCase() === 'p') showPingAdvice(); // P = Ping advisor
      if (e.key.toLowerCase() === 'c') toggleAICoach(); // C = Coach toggle
      if (e.key.toLowerCase() === 'r') showReplayMemory(); // R = Review replay moments
      if (e.key.toLowerCase() === 'x') showMatchupAnalyzer(); // X = Compare to pros
      if (e.key.toLowerCase() === 't') startTourneyMode(); // T = Tournament mode
    });

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      filterDrops();
      loadMapImage(); // Load fortnite.gg map for rotation canvas
      setTimeout(drawRotationMap, 100);

      // Initialize Leaflet map when Map tab is shown
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          if (tab.dataset.tab === 'map') {
            setTimeout(() => {
              initLeafletMap();
              if (leafletMap) leafletMap.invalidateSize();
            }, 100);
          }
        });
      });

      window.addEventListener('resize', () => {
        drawRotationMap();
        if (leafletMap) leafletMap.invalidateSize();
      });

      // Load saved session
      const saved = localStorage.getItem('igl_session');
      if (saved) {
        try {
          sessionStats = JSON.parse(saved);
          updateLiveDisplay();
        } catch(e) {}
      }

      // Save session on unload
      window.addEventListener('beforeunload', () => {
        localStorage.setItem('igl_session', JSON.stringify(sessionStats));
      });
    });
  </script>
</body>
</html>
